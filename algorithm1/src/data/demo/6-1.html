<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>有效括号 · 算法推演（Dart）</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1527;
      --text:#d7e1ff;
      --muted:#9fb0e6;
      --accent:#7aa2ff;
      --good:#41d392;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --code:#0b1326;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1200px 800px at 10% 10%, #13244a 0%, var(--bg) 55%, #060a14 100%);
      color:var(--text);
    }
    .app{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
      min-height: 100vh;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .title h1{ margin:0; font-size: 18px; letter-spacing:.3px; }
    .title p{ margin:0; color:var(--muted); font-size: 13px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.good{ border-color: rgba(65,211,146,.35); background: rgba(65,211,146,.12); color: #bff6df; }
    .badge.bad{ border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.12); color: #ffd0db; }
    .badge.warn{ border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10); color: #ffe8b1; }

    .controls{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .controls .left, .controls .right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      font-size: 13px;
    }
    input[type="text"]{
      width: 280px;
      max-width: 80vw;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(5,10,20,.65);
      color: var(--text);
      outline:none;
    }
    input[type="range"]{ width: 160px; }
    button{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 10px;
      cursor:pointer;
      transition: .15s transform, .15s background;
      font-weight: 700;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(122,162,255,.18);
      border-color: rgba(122,162,255,.35);
    }
    button.danger{
      background: rgba(255,92,122,.14);
      border-color: rgba(255,92,122,.3);
    }
    .toggle{
      user-select:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size: 13px;
      color: var(--muted);
    }
    .toggle input{ accent-color: var(--accent); }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      min-height: 0;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 0;
    }
    .cardHeader{
      padding: 12px 12px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .cardHeader .h{
      display:flex; flex-direction:column; gap:2px;
    }
    .cardHeader .h b{ font-size: 14px; }
    .cardHeader .h span{ font-size: 12px; color: var(--muted); }

    /* Code panel */
    .codeWrap{
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.08));
    }
    .codeToolbar{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      color: var(--muted);
      font-size: 12px;
    }
    .codeToolbar .spacer{ flex:1; }
    .smallBtn{
      padding: 7px 10px;
      border-radius: 9px;
      font-size: 12px;
      font-weight: 800;
    }
    .codeViewport{
      background: var(--code);
      overflow:auto;
      height: calc(100vh - 230px);
      min-height: 420px;
    }
    @media (max-width: 980px){
      .codeViewport{ height: 420px; }
    }

    #codePre{
      margin:0;
      padding: 10px 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      line-height: 1.55;
      color: #d9e2ff;
      tab-size: 2;
    }
    .codeLine{
      display:grid;
      grid-template-columns: 54px 1fr;
      align-items:stretch;
      padding: 0 12px;
    }
    .ln{
      color: rgba(159,176,230,.65);
      text-align:right;
      padding-right: 12px;
      border-right: 1px solid rgba(255,255,255,.06);
      user-select:none;
    }
    .src{
      padding-left: 12px;
      white-space: pre;
      overflow-wrap: normal;
    }
    .wrap .src{ white-space: pre-wrap; overflow-wrap:anywhere; }
    .codeLine.active{
      background: linear-gradient(90deg, rgba(122,162,255,.18), rgba(122,162,255,.06));
    }
    .codeLine.active .ln{ color: var(--accent); }

    /* Syntax colors */
    .kw{ color: #9dffb3; font-weight: 800; }
    .type{ color: #7aa2ff; font-weight: 800; }
    .fn{ color: #ffd166; font-weight: 800; }
    .str{ color: #ff89b0; }
    .cm{ color: #7aa0c8; font-style: italic; }
    .num{ color: #b4f0ff; }
    .op{ color: #cfd8ff; }
    .br{ color: #ffcf6a; font-weight: 900; } /* bracket highlight */

    /* Debug panel */
    .debug{
      padding: 12px;
      display:grid;
      grid-template-rows: auto auto 1fr;
      gap: 10px;
      min-height: 0;
    }
    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 480px){
      .meta{ grid-template-columns: 1fr; }
    }
    .box{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 10px;
    }
    .box h3{
      margin:0 0 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.2px;
    }
    .big{
      font-size: 18px;
      font-weight: 900;
      letter-spacing:.2px;
    }
    .hint{ color: var(--muted); font-size: 12px; }

    .stackWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      min-height: 0;
    }
    .stackArea{
      display:flex;
      gap:10px;
      align-items:flex-end;
      padding: 10px;
      min-height: 110px;
      overflow:auto;
      border-radius: 12px;
      background: rgba(5,10,20,.45);
      border: 1px solid rgba(255,255,255,.10);
    }
    .stackItem{
      min-width: 44px;
      height: 44px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      font-weight: 900;
      font-size: 18px;
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
      position:relative;
    }
    .stackItem.top{
      outline: 2px solid rgba(122,162,255,.55);
      background: rgba(122,162,255,.15);
    }
    .log{
      overflow:auto;
      min-height: 0;
      height: calc(100vh - 420px);
      padding: 10px;
      border-radius: 12px;
      background: rgba(5,10,20,.45);
      border: 1px solid rgba(255,255,255,.10);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      color: #cfe0ff;
      white-space: pre-wrap;
    }
    @media (max-width: 980px){
      .log{ height: 260px; }
    }

    .footerTip{
      color: var(--muted);
      font-size: 12px;
      padding: 10px 12px;
      border-top: 1px solid rgba(255,255,255,.08);
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="title">
      <h1>有效括号（LeetCode 20）· 算法推演动画（Dart）</h1>
      <p>左侧代码高亮执行行 + 语法着色，右侧可视化栈变化。支持单步/播放/速度/重置/自定义输入。</p>
    </div>
    <span class="badge warn">输入示例：()[]{}、([)]、{[()()]}</span>
  </header>

  <div class="controls">
    <div class="left">
      <div class="pill">
        <span>输入 s：</span>
        <input id="inputStr" type="text" value="{[()()]}" />
      </div>
      <button id="btnBuild" class="primary">重新推演</button>
      <button id="btnStep">单步</button>
      <button id="btnPlay" class="primary">播放</button>
      <button id="btnPause">暂停</button>
      <button id="btnReset" class="danger">重置</button>
    </div>

    <div class="right">
      <div class="pill">
        <span>速度</span>
        <input id="speed" type="range" min="0" max="100" value="55"/>
        <span id="speedLabel" style="width:72px; display:inline-block; text-align:right;">650ms</span>
      </div>
      <label class="toggle" title="开启后代码行会自动换行">
        <input id="wrapToggle" type="checkbox" />
        代码自动换行
      </label>
      <button id="btnFontMinus" class="smallBtn">A-</button>
      <button id="btnFontPlus" class="smallBtn">A+</button>
    </div>
  </div>

  <div class="grid">
    <!-- Code Panel -->
    <section class="card codeWrap">
      <div class="cardHeader">
        <div class="h">
          <b>Dart 代码（语法着色 + 行高亮）</b>
          <span class="hint">当前执行到哪一行，会被高亮显示</span>
        </div>
        <span class="badge">函数：isValid(s)</span>
      </div>

      <div class="codeToolbar">
        <span>提示：右侧“栈”从左到右表示从底到顶（最右侧是栈顶）</span>
        <span class="spacer"></span>
        <span class="hint">当前步：<b id="stepCounter">0 / 0</b></span>
      </div>

      <div id="codeViewport" class="codeViewport">
        <div id="codePre"></div>
      </div>

      <div class="footerTip">
        映射规则：每一步都对应一次“读字符 / 判断 / 入栈或出栈 / 检查失败 / 最终返回”等动作。
      </div>
    </section>

    <!-- Debug Panel -->
    <section class="card">
      <div class="cardHeader">
        <div class="h">
          <b>调试区（栈变化 + 变量 + 日志）</b>
          <span class="hint">单步观察：当前字符 c、动作、stack</span>
        </div>
        <span id="resultBadge" class="badge warn">等待推演</span>
      </div>

      <div class="debug">
        <div class="meta">
          <div class="box">
            <h3>当前字符</h3>
            <div class="big" id="curChar">—</div>
            <div class="hint" id="curIndex">index：—</div>
          </div>
          <div class="box">
            <h3>当前动作</h3>
            <div class="big" id="curAction">—</div>
            <div class="hint" id="curExplain">—</div>
          </div>
        </div>

        <div class="stackWrap">
          <div class="box">
            <h3>栈（stack）</h3>
            <div id="stackArea" class="stackArea"></div>
            <div class="hint" id="stackHint">空栈：没有未匹配的左括号</div>
          </div>

          <div class="box" style="min-height:0;">
            <h3>日志（最近在下方）</h3>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
/** =========================
 * 1) Dart 源码（用于展示）
 * ========================= */
const DART_CODE = [
  `class Solution {`,
  `  bool isValid(String s) {`,
  `    List stack = [];`,
  `    Map pairs = {`,
  `      ')': '(',`,
  `      ']': '[',`,
  `      '}': '{',`,
  `    };`,
  ``,
  `    for (var c in s.split('')) {`,
  `      if (pairs.containsValue(c)) {`,
  `        // 左括号入栈`,
  `        stack.add(c);`,
  `      } else if (pairs.containsKey(c)) {`,
  `        // 右括号检查匹配`,
  `        if (stack.isEmpty || stack.removeLast() != pairs[c]) {`,
  `          return false;`,
  `        }`,
  `      }`,
  `    }`,
  `    return stack.isEmpty;`,
  `  }`,
  `}`
];

/** =========================
 * 2) 语法着色（稳定版：占位符保护）
 * ========================= */
function escapeHtml(s){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

// ✅ 单次扫描：只在“纯文本”上做高亮，永远不会去改动已生成的 <span> 标签
function highlightDart(line){
  const text = escapeHtml(line);

  // 注意：这里刻意不把 < 和 > 当作“操作符”高亮（否则会把 <span> 标签拆掉）
  const re = /\/\/.*$|'([^'\\]|\\.)*'|\b(class|for|var|in|if|else|return|true|false)\b|\b(Solution|String|List|Map|bool)\b|\b(isValid|containsValue|containsKey|split|add|removeLast|isEmpty)\b|\b(\d+)\b|(\|\||!=|==|<=|>=|=|\+|\-|\*|\/)|[()\[\]{}]/g;

  return text.replace(re, (m, _s1, kw, type, fn, num, op) => {
    if (m.startsWith('//')) return `<span class="cm">${m}</span>`;
    if (m.startsWith("'"))  return `<span class="str">${m}</span>`;
    if (kw)   return `<span class="kw">${m}</span>`;
    if (type) return `<span class="type">${m}</span>`;
    if (fn)   return `<span class="fn">${m}</span>`;
    if (num)  return `<span class="num">${m}</span>`;
    if (op)   return `<span class="op">${m}</span>`;
    // brackets
    return `<span class="br">${m}</span>`;
  });
}


function renderCode(activeLine = -1){
  const pre = document.getElementById('codePre');
  pre.innerHTML = '';

  DART_CODE.forEach((line, i) => {
    const lineNo = i + 1;

    const row = document.createElement('div');
    row.className = 'codeLine' + (lineNo === activeLine ? ' active' : '');
    row.dataset.line = lineNo;

    const ln = document.createElement('div');
    ln.className = 'ln';
    ln.textContent = lineNo;

    const src = document.createElement('div');
    src.className = 'src';
    src.innerHTML = highlightDart(line === '' ? ' ' : line);

    row.appendChild(ln);
    row.appendChild(src);
    pre.appendChild(row);
  });
}

function scrollCodeToLine(line){
  if (line < 1) return;
  const viewport = document.getElementById('codeViewport');
  const el = viewport.querySelector(`.codeLine[data-line="${line}"]`);
  if (!el) return;
  const top = el.offsetTop;
  const vh = viewport.clientHeight;
  viewport.scrollTo({ top: Math.max(0, top - vh * 0.35), behavior: 'smooth' });
}

/** =========================
 * 3) 算法推演（生成 steps）
 * ========================= */
function buildSteps(s){
  const pairs = { ')':'(', ']':'[', '}':'{' };
  const leftSet = new Set(Object.values(pairs));
  const rightSet = new Set(Object.keys(pairs));

  const stack = [];
  const steps = [];

  function step(obj){
    steps.push({
      line: obj.line ?? -1,
      index: obj.index ?? -1,
      char: obj.char ?? '',
      action: obj.action ?? '',
      explain: obj.explain ?? '',
      stack: [...stack],
      ok: obj.ok ?? null,
      done: obj.done ?? false,
      ret: obj.ret ?? null
    });
  }

  step({ line: 2, action:'开始', explain:`准备检查字符串 s = "${s}"` });
  step({ line: 3, action:'初始化', explain:'stack = []' });
  step({ line: 4, action:'初始化', explain:'pairs = { ):(, ]:[, }:{ }' });

  const chars = [...s];
  for (let i=0;i<chars.length;i++){
    const c = chars[i];

    step({ line: 9, index:i, char:c, action:'读取字符', explain:`c = '${c}'` });

    if (leftSet.has(c)){
      step({ line: 10, index:i, char:c, action:'判断', explain:`'${c}' 是左括号（containsValue 为 true）` });
      step({ line: 12, index:i, char:c, action:'入栈', explain:`stack.add('${c}')` });
      stack.push(c);
      step({ line: 12, index:i, char:c, action:'栈更新', explain:`stack = [${stack.join(' ')}]` });
      continue;
    }

    if (rightSet.has(c)){
      step({ line: 13, index:i, char:c, action:'判断', explain:`'${c}' 是右括号（containsKey 为 true）` });

      const need = pairs[c];
      if (stack.length === 0){
        step({ line: 15, index:i, char:c, action:'匹配失败', explain:`空栈：无法匹配 '${c}' 需要 '${need}'`, ok:false });
        step({ line: 16, index:i, char:c, action:'返回', explain:'return false', done:true, ret:false });
        return steps;
      }

      const top = stack[stack.length-1];
      if (top !== need){
        step({ line: 15, index:i, char:c, action:'匹配失败', explain:`栈顶 '${top}' != '${need}'`, ok:false });
        step({ line: 15, index:i, char:c, action:'出栈并比较', explain:`removeLast() -> '${top}'，比较失败` });
        stack.pop();
        step({ line: 16, index:i, char:c, action:'返回', explain:'return false', done:true, ret:false });
        return steps;
      }

      step({ line: 15, index:i, char:c, action:'出栈并比较', explain:`removeLast() -> '${top}'，匹配成功`, ok:true });
      stack.pop();
      step({ line: 15, index:i, char:c, action:'栈更新', explain:`stack = [${stack.join(' ')}]` });
      continue;
    }

    step({ line: 9, index:i, char:c, action:'忽略', explain:`'${c}' 不是括号字符` });
  }

  step({ line: 20, action:'最终检查', explain:'return stack.isEmpty' });
  const ret = stack.length === 0;
  step({ line: 20, action:'返回', explain:`stack ${ret ? '为空' : '不为空'} -> return ${ret}`, done:true, ret });
  return steps;
}

/** =========================
 * 4) 播放器与 UI 更新
 * ========================= */
let steps = [];
let ptr = 0;
let timer = null;
let delayMs = 650;
let fontSize = 13;

function updateStepCounter(){
  document.getElementById('stepCounter').textContent =
    `${Math.min(ptr+1, steps.length)} / ${steps.length}`;
}

function setBadge(type, text){
  const badge = document.getElementById('resultBadge');
  badge.className = 'badge ' + type;
  badge.textContent = text;
}

function renderStack(arr){
  const area = document.getElementById('stackArea');
  area.innerHTML = '';
  if (!arr || arr.length === 0){
    document.getElementById('stackHint').textContent = '空栈：没有未匹配的左括号';
    return;
  }
  document.getElementById('stackHint').textContent = `当前未匹配左括号数量：${arr.length}`;
  arr.forEach((ch, idx) => {
    const d = document.createElement('div');
    d.className = 'stackItem' + (idx === arr.length - 1 ? ' top' : '');
    d.textContent = ch;
    area.appendChild(d);
  });
}

function appendLog(line){
  const log = document.getElementById('log');
  log.textContent += line + "\n";
  log.scrollTop = log.scrollHeight;
}
function clearLog(){
  document.getElementById('log').textContent = '';
}

function applyWrap(){
  const wrap = document.getElementById('wrapToggle').checked;
  document.getElementById('codePre').classList.toggle('wrap', wrap);
}
function applyFont(){
  document.getElementById('codePre').style.fontSize = fontSize + 'px';
}

function renderAt(i){
  if (!steps.length) return;
  const st = steps[Math.max(0, Math.min(i, steps.length-1))];

  renderCode(st.line);
  scrollCodeToLine(st.line);

  document.getElementById('curChar').textContent = st.char ? `'${st.char}'` : '—';
  document.getElementById('curIndex').textContent = st.index >= 0 ? `index：${st.index}` : `index：—`;
  document.getElementById('curAction').textContent = st.action || '—';
  document.getElementById('curExplain').textContent = st.explain || '—';

  renderStack(st.stack);

  if (st.done){
    setBadge(st.ret === true ? 'good' : 'bad', `结果：${st.ret}（${st.ret ? '有效' : '无效'}）`);
  } else {
    setBadge('warn', '推演中…');
  }
  updateStepCounter();
}

function stepOnce(){
  if (!steps.length || ptr >= steps.length) return;

  const st = steps[ptr];
  renderAt(ptr);

  const idxPart = st.index >= 0 ? `i=${st.index}` : '';
  const cPart = st.char ? `c='${st.char}'` : '';
  const head = `[${String(ptr+1).padStart(2,'0')}/${steps.length}]`;
  appendLog(`${head} ${idxPart} ${cPart} :: ${st.action} -> ${st.explain}`);

  ptr++;
  if (ptr >= steps.length) stopPlay();
}

function play(){
  if (timer) return;
  timer = setInterval(() => {
    if (ptr >= steps.length) return stopPlay();
    stepOnce();
  }, delayMs);
}
function stopPlay(){
  if (timer){ clearInterval(timer); timer = null; }
}

function reset(){
  stopPlay();
  ptr = 0;
  clearLog();
  if (steps.length){
    renderAt(0);
    setBadge('warn','等待推演');
  }
}

function rebuild(){
  stopPlay();
  const s = document.getElementById('inputStr').value ?? '';
  steps = buildSteps(s);
  ptr = 0;
  clearLog();
  renderAt(0);
  setBadge('warn','等待推演');
}

/** =========================
 * 5) 事件绑定
 * ========================= */
document.getElementById('btnBuild').addEventListener('click', rebuild);
document.getElementById('btnStep').addEventListener('click', stepOnce);
document.getElementById('btnPlay').addEventListener('click', play);
document.getElementById('btnPause').addEventListener('click', stopPlay);
document.getElementById('btnReset').addEventListener('click', reset);

document.getElementById('speed').addEventListener('input', (e) => {
  const v = Number(e.target.value);
  delayMs = Math.round(1200 - v * 10.8);
  document.getElementById('speedLabel').textContent = `${delayMs}ms`;
  if (timer){ stopPlay(); play(); }
});

document.getElementById('wrapToggle').addEventListener('change', applyWrap);
document.getElementById('btnFontMinus').addEventListener('click', () => {
  fontSize = Math.max(11, fontSize - 1);
  applyFont();
});
document.getElementById('btnFontPlus').addEventListener('click', () => {
  fontSize = Math.min(18, fontSize + 1);
  applyFont();
});
document.getElementById('inputStr').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') rebuild();
});

/** =========================
 * 6) 初始化
 * ========================= */
renderCode(-1);     // 先渲染一次，确保你一打开就能看到着色效果
applyWrap();
applyFont();
rebuild();          // 再生成推演步骤并高亮行
</script>
</body>
</html>
