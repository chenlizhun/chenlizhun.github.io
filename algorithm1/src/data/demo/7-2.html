<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>存在重复元素 II · 算法推演（Dart思路）</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0c1527;
      --text:#d7e1ff;
      --muted:#9fb0e6;
      --line:#1b2b4b;
      --accent:#7aa2ff;
      --good:#41d392;
      --bad:#ff5c7a;
      --warn:#ffd166;
      --code:#0b1326;
      --hl:#142a52;
      --hl2:#1f3b73;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #172a57 0%, rgba(23,42,87,0) 55%),
                  radial-gradient(900px 500px at 100% 20%, #2a1c57 0%, rgba(42,28,87,0) 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .title{
      display:flex; flex-direction:column; gap:6px;
    }
    h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size: 13px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight: 800;
      letter-spacing:.4px;
    }
    .pill.good{ color: var(--good); border-color: rgba(65,211,146,.35); background: rgba(65,211,146,.10); }
    .pill.bad{ color: var(--bad); border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10); }
    .pill.warn{ color: var(--warn); border-color: rgba(255,209,102,.35); background: rgba(255,209,102,.10); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .grid{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap: 12px;
    }
    .card{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.18));
      border-radius: 14px;
      overflow:hidden;
    }
    .card-head{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .card-body{
      padding: 12px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .inp{ display:flex; flex-direction:column; gap:6px; flex:1; }
    .inp input{
      height: 36px; border-radius: 10px; border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14); color: var(--text); padding: 0 10px;
    }
    .btns{ display:flex; align-items:center; gap:8px; }
    button{
      height: 34px; padding: 0 12px; border-radius: 10px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12); color: var(--text);
    }
    button.primary{ background: rgba(122,162,255,.20); border-color: rgba(122,162,255,.40); }
    button.danger{ background: rgba(255,92,122,.20); border-color: rgba(255,92,122,.40); }
    .slider{ display:flex; align-items:center; gap:8px; }
    input[type="range"]{ width: 160px; }

    .bigline{ display:grid; grid-template-columns: 1fr; gap:10px; }
    .stringBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .stringBox .cap{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 8px; }
    .stringBox .cap b{ font-size: 13px; color: var(--muted); font-weight: 600; }
    .chars{ display:flex; flex-wrap:wrap; gap:6px; }
    .ch{
      min-width: 28px; height: 28px; display:flex; align-items:center; justify-content:center;
      border-radius: 10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.14); font-size: 14px;
    }
    .ch.cur{ border-color: rgba(122,162,255,.60); background: rgba(122,162,255,.16); }
    .ch.done{ opacity:.55; }
    .idx{ font-size:12px; color: var(--muted); }
    .log{ border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); border-radius: 14px; padding: 10px 12px; min-height: 124px; max-height: 220px; overflow:auto; }
    .log .item{ padding: 8px 8px; border-radius: 12px; }
    .kv{ display:flex; align-items:center; justify-content:space-between; gap:10px; border-radius: 12px; padding: 8px 10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.14); min-height: 44px; }
    .kv .key{ font-weight: 700; letter-spacing:.4px; padding: 4px 9px; border-radius: 10px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.14); }
    .kv .val{ font-weight: 800; font-size: 14px; }
    .kv.cur{ border-color: rgba(122,162,255,.60); background: rgba(122,162,255,.10); }
    .kv.neg .val{ color: var(--bad); }
    .kv.zero .val{ opacity:.6; }
    .kv.pos .val{ color: var(--good); }

    .code{
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(0,0,0,.26), rgba(0,0,0,.18));
      border-radius: 14px;
      padding: 12px;
      overflow:auto;
      font-size: 12.5px;
      line-height: 1.6;
    }
    .codeLine{
      display:grid;
      grid-template-columns: 54px 1fr;
      padding: 2px 8px;
      border-radius: 10px;
      align-items:stretch;
    }
    .codeLine.hl{ background: rgba(122,162,255,.14); outline: 1px solid rgba(122,162,255,.18); }
    .ln{
      color: rgba(159,176,230,.65);
      text-align:right;
      padding-right: 12px;
      border-right: 1px solid rgba(255,255,255,.10);
      user-select:none;
    }
    .src{
      padding-left: 12px;
      white-space: pre;
    }
    .kw{ color: #9dffb3; font-weight: 700; }
    .type{ color: #7aa2ff; }
    .fn{ color: #ffd166; font-weight: 700; }
    .str{ color: #ff89b0; }
    .cm{ color: #7aa0c8; font-style: italic; }
    .num{ color: #b4f0ff; }
    .op{ color: #cfd8ff; }
    .hint{ color: var(--muted); font-size: 12px; line-height: 1.45; margin-top: 8px; }
    .footerNote{ margin-top: 10px; color: var(--muted); font-size: 12px; opacity:.9; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="title">
      <h1>存在重复元素 II（Contains Nearby Duplicate）· 算法推演</h1>
      <div class="sub">思路：遍历数组，使用 Map 记录元素的最近索引，若遇到相同元素且索引差 ≤ k，则返回 true。</div>
    </div>
    <div class="pill mono" id="statusPill">READY</div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="card-head">
        <h2>输入与控制</h2>
        <div class="row">
          <span class="pill mono" id="stepPill">step 0/0</span>
          <span class="pill mono" id="phasePill">phase: -</span>
        </div>
      </div>
      <div class="card-body">
        <div class="row" style="margin-bottom:10px;">
          <div class="inp">
            <label>nums（数组）</label>
            <input id="inNums" type="text" value="1,2,3,1" />
          </div>
          <div class="inp">
            <label>k（距离阈值）</label>
            <input id="inK" type="number" value="3" />
          </div>
        </div>

        <div class="row" style="margin-bottom:10px;">
          <div class="btns">
            <button class="primary" id="btnBuild">生成推演</button>
            <button id="btnStep" disabled>单步 ▶</button>
            <button id="btnPlay" disabled>自动播放 ⏵</button>
            <button class="danger" id="btnStop" disabled>停止 ⏹</button>
            <button id="btnReset" disabled>重置 ↺</button>
          </div>

          <div class="slider">
            <span>速度</span>
            <input id="speed" type="range" min="120" max="1200" value="520" />
            <span class="mono" id="speedVal">520ms</span>
          </div>
        </div>

        <div class="bigline">
          <div class="stringBox">
            <div class="cap">
              <b>nums：遍历检查</b>
              <span class="idx mono" id="iIdx">i = -</span>
            </div>
            <div class="chars" id="numsChars"></div>
          </div>

          <div class="stringBox">
            <div class="cap">
              <b>索引 Map（值 → 最近索引）</b>
              <span class="idx mono" id="curInfo">cur = -</span>
            </div>
            <div class="mapGrid" id="mapGrid"></div>
            <div class="hint">若出现相同值且索引差 ≤ k，则立即判定 true。</div>
          </div>

          <div class="log" id="log"></div>
        </div>

        <div class="footerNote mono">可试：nums="1,2,3,1", k=3；或 nums="1,0,1,1", k=1。</div>
      </div>
    </section>

    <aside class="card">
      <div class="card-head">
        <h2>Dart 伪代码（对齐你的实现）</h2>
        <span class="pill mono" id="linePill">line -</span>
      </div>
      <div class="card-body">
        <div class="code mono" id="codeBox"></div>
        <div class="hint">
          行高亮会跟随推演步骤：遍历 nums，检查 Map 中是否存在该值且索引差 ≤ k，满足则 true，否则更新索引。
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
(() => {
  const inNums = document.getElementById('inNums');
  const inK = document.getElementById('inK');
  const btnBuild = document.getElementById('btnBuild');
  const btnStep  = document.getElementById('btnStep');
  const btnPlay  = document.getElementById('btnPlay');
  const btnStop  = document.getElementById('btnStop');
  const btnReset = document.getElementById('btnReset');
  const speed = document.getElementById('speed');
  const speedVal = document.getElementById('speedVal');

  const numsChars = document.getElementById('numsChars');
  const mapGrid = document.getElementById('mapGrid');
  const logEl = document.getElementById('log');

  const statusPill = document.getElementById('statusPill');
  const stepPill = document.getElementById('stepPill');
  const phasePill = document.getElementById('phasePill');
  const linePill = document.getElementById('linePill');
  const iIdx = document.getElementById('iIdx');
  const curInfo = document.getElementById('curInfo');
  const codeBox = document.getElementById('codeBox');

  const CODE = [
    'class Solution {',
    '  bool containsNearbyDuplicate(List nums, int k) {',
    '    Map map = {};',
    '    for (int i = 0; i < nums.length; i++) {',
    '      if (map.containsKey(nums[i]) && (i - map[nums[i]]!) <= k) {',
    '        return true;',
    '      }',
    '      map[nums[i]] = i;',
    '    }',
    '    return false;',
    '  }',
    '}'
  ];
function escapeHtml(s){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;');
}

// ✅ 单次扫描：只在“纯文本”上做高亮，永远不会去改动已生成的 <span> 标签
function highlightDart(line){
  const text = escapeHtml(line);

  // 注意：这里刻意不把 < 和 > 当作“操作符”高亮（否则会把 <span> 标签拆掉）
  const re = /\/\/.*$|'([^'\\]|\\.)*'|\b(class|for|var|in|if|else|return|true|false)\b|\b(Solution|String|List|Map|bool)\b|\b(isValid|containsValue|containsKey|split|add|removeLast|isEmpty)\b|\b(\d+)\b|(\|\||!=|==|<=|>=|=|\+|\-|\*|\/)|[()\[\]{}]/g;

  return text.replace(re, (m, _s1, kw, type, fn, num, op) => {
    if (m.startsWith('//')) return `<span class="cm">${m}</span>`;
    if (m.startsWith("'"))  return `<span class="str">${m}</span>`;
    if (kw)   return `<span class="kw">${m}</span>`;
    if (type) return `<span class="type">${m}</span>`;
    if (fn)   return `<span class="fn">${m}</span>`;
    if (num)  return `<span class="num">${m}</span>`;
    if (op)   return `<span class="op">${m}</span>`;
    // brackets
    return `<span class="br">${m}</span>`;
  });
}
  function renderCode(activeLineIdx) {
    codeBox.innerHTML = '';
    CODE.forEach((line, i) => {
      const row = document.createElement('div');
      row.className = 'codeLine' + (i === activeLineIdx ? ' hl' : '');
      const ln = document.createElement('div');
      ln.className = 'ln';
      ln.textContent = i + 1;
      const src = document.createElement('div');
      src.className = 'src';
      src.innerHTML = highlightDart(line === '' ? ' ' : line);
      row.appendChild(ln);
      row.appendChild(src);
      codeBox.appendChild(row);
    });
    linePill.textContent = 'line ' + (activeLineIdx == null ? '-' : (activeLineIdx + 1));
  }

  let steps = [];
  let idxStep = 0;
  let playing = false;
  let timer = null;
  const state = { nums: [], k: 0, i: -1, cur: null, map: new Map(), result: null };

  function log(kind, title, detail){
    const div = document.createElement('div'); div.className = 'item';
    const k = document.createElement('div'); k.className = 'k mono'; k.textContent = title;
    const v = document.createElement('div'); v.className = 'v'; v.innerHTML = detail;
    div.appendChild(k); div.appendChild(v); logEl.prepend(div);
  }
  function renderNums(){
    numsChars.innerHTML = '';
    state.nums.forEach((val, i) => {
      const el = document.createElement('div'); el.className = 'ch mono'; el.textContent = String(val); el.dataset.i = i; numsChars.appendChild(el);
    });
  }
  function highlightNums(){
    [...numsChars.children].forEach(el => el.classList.remove('cur'));
    [...numsChars.children].forEach(el => { const i = Number(el.dataset.i); el.classList.toggle('done', state.i >= 0 && i < state.i); });
    if (state.i >= 0 && state.i < state.nums.length){ const el = numsChars.querySelector(`.ch[data-i="${state.i}"]`); if (el) el.classList.add('cur'); }
    iIdx.textContent = 'i = ' + (state.i >= 0 ? state.i : '-');
    curInfo.textContent = 'cur = ' + (state.cur ?? '-');
  }
  function renderMap(){
    mapGrid.innerHTML = '';
    const entries = [...state.map.entries()].sort((a,b)=> String(a[0]).localeCompare(String(b[0])));
    if (entries.length === 0){ const empty = document.createElement('div'); empty.className = 'pill mono'; empty.textContent = 'Map 为空'; mapGrid.appendChild(empty); return; }
    entries.forEach(([key, idx]) => {
      const row = document.createElement('div'); row.className = 'kv';
      const left = document.createElement('div'); left.className = 'key mono'; left.textContent = String(key);
      const right = document.createElement('div'); right.className = 'val mono'; right.textContent = String(idx);
      row.appendChild(left); row.appendChild(right); mapGrid.appendChild(row);
    });
  }

  function buildSteps(nums, k){
    const arr = nums; const ret = [];
    ret.push({ line: 2, msg: `初始化 k=${k}` });
    ret.push({ line: 3, msg: `初始化 map = {}` });
    for (let i=0;i<arr.length;i++){
      const v = arr[i];
      ret.push({ line: 4, i, cur:v, msg:`读取 nums[${i}] = ${v}` });
      const has = state.map.has(v);
      if (has){
        const prev = state.map.get(v);
        ret.push({ line: 5, i, cur:v, msg:`检测相同值 ${v}，之前索引=${prev}，差=${i - prev}，k=${k}` });
        if ((i - prev) <= k){
          ret.push({ line: 6, i, cur:v, done:true, result:true, msg:`索引差 ≤ k，返回 true` });
          break;
        }
      }
      ret.push({ line: 8, i, cur:v, msg:`更新 map[${v}] = ${i}` });
      state.map.set(v, i);
    }
    if (ret.length === 0 || !ret[ret.length-1].done){ ret.push({ line: 10, done:true, result:false, msg:`遍历结束，返回 false` }); }
    return ret;
  }
  function resetUI(){
    numsChars.innerHTML = ''; mapGrid.innerHTML=''; logEl.innerHTML=''; iIdx.textContent='i = -'; curInfo.textContent='cur = -';
    stepPill.textContent = 'step 0/0'; phasePill.textContent='phase: -'; statusPill.className='pill mono'; statusPill.textContent='READY';
    renderCode(null);
  }
  function updatePills(){ stepPill.textContent = `step ${Math.min(idxStep+1, steps.length)}/${steps.length}`; }
  function setBadge(type,text){ statusPill.className='pill mono'; if(type==='good')statusPill.classList.add('good'); if(type==='bad')statusPill.classList.add('bad'); if(type==='warn')statusPill.classList.add('warn'); statusPill.textContent=text; }

  function renderAt(i){
    const st = steps[Math.max(0, Math.min(i, steps.length-1))];
    state.i = st.i ?? state.i; state.cur = st.cur ?? state.cur;
    renderCode(st.line-1 >=0 ? st.line-1 : null);
    renderNums(); highlightNums(); renderMap();
    if (st.msg){ log('info', `[step ${i+1}]`, st.msg); }
    if (st.done){ setBadge(st.result ? 'good':'bad', st.result ? '结果：true' : '结果：false'); }
    updatePills();
  }
  function stepOnce(){ if (steps.length===0) return; if (idxStep>=steps.length) return; renderAt(idxStep); idxStep++; if (idxStep>=steps.length) stop(); }
  function play(){ if (playing) return; playing=true; btnStop.disabled=false; btnPlay.disabled=true; btnStep.disabled=true; const tick=()=>{ if(!playing)return; if(idxStep>=steps.length){ stop(); return; } stepOnce(); timer=setTimeout(tick, Number(speed.value)); }; tick(); }
  function stop(){ playing=false; if(timer)clearTimeout(timer); timer=null; btnStop.disabled=true; btnPlay.disabled=(idxStep>=steps.length); btnStep.disabled=(idxStep>=steps.length); }
  function resetAll(){ stop(); idxStep=0; state.i=-1; state.cur=null; state.map = new Map(); state.result=null; resetUI(); renderNums(); renderMap(); highlightNums(); renderCode(null); btnStep.disabled=steps.length===0; btnPlay.disabled=steps.length===0; btnStop.disabled=true; btnReset.disabled=steps.length===0; }

  function build(){
    stop();
    const nums = (inNums.value || '').split(',').map(s => s.trim()).filter(s => s.length>0).map(x => Number(x));
    const k = Number(inK.value) || 0;
    state.nums = nums; state.k = k; state.i=-1; state.cur=null; state.map = new Map();
    steps = buildSteps(nums, k); idxStep = 0;
    resetUI(); renderNums(); renderMap(); highlightNums(); renderCode(null);
    btnStep.disabled = false; btnPlay.disabled = false; btnStop.disabled = true; btnReset.disabled = false;
    updatePills(); setBadge('warn','READY');
    log('info', '[build] steps', `已生成 <b class="mono">${steps.length}</b> 个步骤。遍历 nums 检查索引差 ≤ k。`);
  }

  btnBuild.addEventListener('click', build);
  btnStep.addEventListener('click', stepOnce);
  btnPlay.addEventListener('click', play);
  btnStop.addEventListener('click', stop);
  btnReset.addEventListener('click', resetAll);
  speed.addEventListener('input', () => { speedVal.textContent = speed.value + 'ms'; });

  speedVal.textContent = speed.value + 'ms';
  resetUI(); renderCode(null);
})();
</script>
</body>
</html>
