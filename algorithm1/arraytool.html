<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®—æ³•æ¨æ¼”å·¥å…· - å¤šæ•°ç»„æŒ‡é’ˆäº¤äº’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Microsoft YaHei', monospace;
        }

        body {
            padding: 0.75rem;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        h1 {
            color: #0f3460;
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* æ•°ç»„æ¨¡å¼åˆ‡æ¢ */
        .mode-switch {
            margin-bottom: 1.2rem;
            text-align: center;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
        }

        .mode-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 8px;
            background: #e0e6ed;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: #0f3460;
            color: white;
            box-shadow: 0 4px 12px rgba(15, 52, 96, 0.3);
            transform: translateY(-2px);
        }

        /* æ•°ç»„é…ç½®åŒºåŸŸ */
        .array-config {
            margin-bottom: 1.5rem;
            padding: 1.2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .array-config-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }
        .array-config-header .config-title {
            font-weight: 700;
            color: #0f3460;
            font-size: 0.95rem;
        }
        .toggle-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            border: 1px solid #ddd;
            background: #fff;
            color: #0f3460;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .toggle-pill svg {
            width: 14px;
            height: 14px;
        }
        .array-config.collapsed .array-config-body {
            display: none;
        }
        .array-config-body {
            padding-top: 0.8rem;
        }

        .array-input-group {
            display: flex;
            gap: 0.6rem;
            align-items: center;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        .array-input-wrapper {
            flex: 1;
            min-width: 180px;
            display: none;
        }

        .array-input-wrapper.active {
            display: block;
        }

        .array-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.85rem;
            background: white;
            transition: border 0.3s;
        }

        .array-input:focus {
            outline: none;
            border-color: #0f3460;
            box-shadow: 0 0 0 2px rgba(15, 52, 96, 0.1);
        }

        /* æŒ‰é’®é€šç”¨æ ·å¼ - æ›´å°æ›´é…· */
        .btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
            min-width: 60px;
            font-weight: 600;
        }

        .btn-primary {
            background: #0f3460;
            color: white;
        }

        .btn-primary:hover {
            background: #1a508b;
            box-shadow: 0 3px 10px rgba(15, 52, 96, 0.3);
            transform: translateY(-1px);
        }

        .btn-success {
            background: #16c79a;
            color: white;
        }

        .btn-success:hover {
            background: #12a178;
            box-shadow: 0 3px 10px rgba(22, 199, 154, 0.3);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: #e63946;
            color: white;
        }

        .btn-danger:hover {
            background: #c72c41;
            box-shadow: 0 3px 10px rgba(230, 57, 70, 0.3);
            transform: translateY(-1px);
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #ddd;
            color: #0f3460;
        }

        .btn-outline:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        /* æŒ‡é’ˆé…ç½® */
        .pointer-config {
            margin-bottom: 0.8rem;
            display: flex;
            gap: 0.6rem;
            align-items: center;
            flex-wrap: wrap;
        }

        #pointer-name {
            padding: 0.3rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.75rem;
            width: 70px;
            transition: border 0.3s;
        }

        #pointer-name:focus {
            outline: none;
            border-color: #0f3460;
            box-shadow: 0 0 0 2px rgba(15, 52, 96, 0.1);
        }

        .pointer-status {
            margin-left: 0.5rem;
            padding: 0.3rem 0.6rem;
            background: #f0f7ff;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #0f3460;
            border: 1px solid #e1f0fe;
            font-weight: 600;
        }

        /* å¯è§†åŒ–åŒºåŸŸ - é…·é£æ ¼ */
        .visualization {
            margin: 1.5rem 0;
            position: relative;
            min-height: 350px;
            padding: 20px;
            width: 100%;
            overflow-x: auto;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .arrays-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .array-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
            min-height: 100px;
            display: none;
            position: relative;
            padding: 10px 0;
            width: 100%;
        }

        .array-container.active {
            display: flex;
        }

        .array-label { font-weight: 600; color: #0f3460; margin-bottom: 8px; cursor: pointer; position: relative; }

        /* æ•°ç»„æ–¹å— - ç™½è‰²èƒŒæ™¯ */
        .array-item {
            width: 70px;
            height: 90px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .array-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .array-item.focused {
            border-color: #1a508b;
            box-shadow: 0 0 0 3px rgba(26, 80, 139, 0.15);
        }

        /* é«˜äº®å½“å‰æŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„å…ƒç´  */
        .array-item.highlighted {
            background: #f0f7ff;
            border-color: #0f3460;
            box-shadow: 0 0 0 3px rgba(15, 52, 96, 0.1);
        }

        /* ç›®æ ‡å€¼é«˜äº® */
        .array-item.target-match {
            background: #fff7ed; /* orange-50 */
            border-color: #fb923c; /* orange-400 */
            box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.25);
        }

        /* ä¸¤æ•°ä¹‹å’Œ=ç›®æ ‡ é«˜äº® */
        .array-item.two-sum-match {
            background: #f0fff4; /* green-50 */
            border-color: #34d399; /* green-400 */
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.25);
        }

        /* ä¸‰æ•°ä¹‹å’Œ=ç›®æ ‡ é«˜äº® */
        .array-item.three-sum-match {
            background: #f5f3ff; /* violet-50 */
            border-color: #a78bfa; /* violet-400 */
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.25);
        }
        .array-container.selected .array-label {
            color: #0ea5e9;
            font-weight: 700;
        }

        .array-index {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #e5e7eb;
            font-weight: 600;
            pointer-events: none;
            opacity: 1;
        }

        .array-item.focused .array-index,
        .array-item.highlighted .array-index {
            color: #9ca3af;
            opacity: 0.9;
        }

        .array-value-text {
            min-width: 50px;
            min-height: 40px;
            padding: 4px 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            border-radius: 8px;
            font-size: 1.2rem;
            background: transparent;
            color: #111827;
            width: 100%;
            max-width: 100%;
        }

        .array-item input {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: none;
        }

        .array-item.editing .array-value {
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            width: calc(100% - 12px);
            max-width: calc(100% - 12px);
            background: #fff;
        }
        .array-item.editing .array-value-text {
            opacity: 0.35;
        }

        

        /* æŒ‡é’ˆæ ·å¼ - æ›´é…·çš„è®¾è®¡ */
        .pointer {
            position: absolute;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 0.8rem;
            z-index: 10;
            opacity: 0.4; /* æ›´ä½çš„é€æ˜åº¦ */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
            pointer-events: auto;
        }

        .pointer::after {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            left: 50%;
            transform: translateX(-50%);
        }

        .pointer.selected {
            opacity: 0.85; /* é€‰ä¸­æ—¶æé«˜ä½†ä»ä½ */
            transform: scale(1.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* æŒ‡é’ˆä½ç½®è°ƒæ•´ - æ›´è´´è¿‘æ•°ç»„å…ƒç´  */
        .pointer.position-top {
            top: calc(var(--item-top) - 20px);
            left: calc(var(--item-left) + 35px);
            transform: translateX(-50%);
        }

        .pointer.position-top::after {
            top: 20px;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 6px solid var(--pointer-color, #0f3460);
        }

        .pointer.position-bottom {
            top: calc(var(--item-top) + 90px);
            left: calc(var(--item-left) + 35px);
            transform: translateX(-50%);
        }

        .pointer.position-bottom::after {
            bottom: 20px;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 6px solid var(--pointer-color, #0f3460);
        }

        /* æ­¥éª¤è®°å½• */
        .steps {
            margin-top: 1.5rem;
            padding: 1.2rem;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .steps h3 {
            margin-bottom: 0.8rem;
            color: #0f3460;
            font-size: 1rem;
            font-weight: 700;
        }

        .step-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 0.8rem;
            background: white;
        }

        .step-item {
            padding: 0.4rem;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #333;
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-time {
            color: #999;
            font-size: 0.75rem;
        }

        /* å¿«ç…§åŒºåŸŸ */
        .snapshot {
            margin-top: 0.8rem;
            padding: 0.8rem;
            background: white;
            border: 1px dashed #ccc;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.85rem;
            color: #0f3460;
        }

        /* ä½¿ç”¨è¯´æ˜ - ç§»åˆ°é¡µé¢åº•éƒ¨ */
        .usage-guide {
            margin-top: 2rem;
            padding: 1rem 1.2rem;
            background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
            border-left: 4px solid #0f3460;
            border-radius: 10px;
            font-size: 0.85rem;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .usage-guide h3 {
            color: #0f3460;
            margin-bottom: 0.5rem;
            font-size: 1rem;
            font-weight: 700;
        }

        .usage-guide ul {
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .usage-guide li {
            margin-bottom: 0.3rem;
        }

        /* å¤šæ•°ç»„æ§åˆ¶æŒ‰é’® */
        .multi-array-controls {
            display: flex;
            gap: 0.6rem;
            margin-bottom: 0.8rem;
            flex-wrap: wrap;
        }

        /* å“åº”å¼ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem 1rem;
            }

            .array-input-group, .pointer-config {
                flex-direction: column;
                align-items: stretch;
            }

            .array-item {
                width: 60px;
                height: 80px;
            }

            .array-item input {
                font-size: 1rem;
            }

            .btn {
                width: 100%;
                margin-bottom: 0.3rem;
            }

            .pointer.position-top {
                top: calc(var(--item-top) - 18px);
            }
            
            .pointer.position-bottom {
                top: calc(var(--item-top) + 80px);
            }

            .usage-guide {
                font-size: 0.8rem;
            }
        }
        .layout {
            display: grid;
            grid-template-columns: var(--left-width, 520px) 6px 1fr;
            gap: 1rem;
        }
        .layout-divider {
            background: transparent;
            border-radius: 6px;
            cursor: col-resize;
            height: 100%;
            align-self: stretch;
            opacity: 0;
        }
        .code-panel.collapsed + .layout-divider {
            display: none;
        }
        .code-panel {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
        }
        .code-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }
        .code-editor {
            width: 100%;
            min-height: 80px;
            height: 90px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            font-family: Consolas, monospace;
            background: #fff;
            margin-top: 0.6rem;
        }
        .code-output {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
            padding: 0.6rem;
            overflow: visible;
            font-size: 0.8rem;
        }
        .code-panel.collapsed {
            display: none;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dart.min.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/standalone.js"></script>
    <script src="https://unpkg.com/prettier@3.2.5/plugins/babel.js"></script>
</head>
<body>
    <div class="container">
        <h1>âš¡ ç®—æ³•æ¨æ¼”å·¥å…· - å¤šæ•°ç»„æŒ‡é’ˆäº¤äº’</h1>
        <!-- é¡¶éƒ¨åŠŸèƒ½æŒ‰é’®åŒºï¼ˆä¸Šæ–¹ï¼‰ -->
        <div class="mode-switch" style="display:none;">
            <button class="mode-btn active" id="single-mode">å•æ•°ç»„æ¨¡å¼</button>
            <button class="mode-btn" id="double-mode">åŒæ•°ç»„æ¨¡å¼</button>
            <button class="mode-btn" id="multi-mode">å¤šæ•°ç»„æ¨¡å¼</button>
        </div>
        <div class="array-config" id="array-config">
            <div class="array-config-header">
                <div class="config-title">åŠŸèƒ½æŒ‰é’®åŒº</div>
                <button class="toggle-pill" id="toggle-controls">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                    æŠ˜å 
                </button>
            </div>
            <div class="array-config-body">
            <!-- å¤šæ•°ç»„æ§åˆ¶ -->
            <div class="multi-array-controls">
                <button class="btn btn-outline" id="add-array">æ·»åŠ æ–°æ•°ç»„</button>
                <button class="btn btn-outline" id="remove-array">åˆ é™¤æœ€åæ•°ç»„</button>
            </div>
            <div class="array-input-group" id="array-inputs-container">
                <div class="array-input-wrapper active" data-array-id="1">
                    <input type="text" class="array-input" data-array-id="1" placeholder="è¾“å…¥æ•°ç»„1ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼š1,3,5,7,9" value="1,3,5,7,9">
                </div>
                <div class="array-input-wrapper" data-array-id="2">
                    <input type="text" class="array-input" data-array-id="2" placeholder="è¾“å…¥æ•°ç»„2ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼š2,4,6,8,10" value="2,4,6,8,10">
                </div>
                <button class="btn btn-primary" id="render-array">æ¸²æŸ“æ•°ç»„</button>
                <button class="btn btn-outline" id="add-array-item">æ·»åŠ å…ƒç´ </button>
                <button class="btn btn-outline" id="remove-array-item">åˆ é™¤å…ƒç´ </button>
                <button class="btn btn-danger" id="clear-all">æ¸…ç©ºæ‰€æœ‰</button>
            </div>
            <div class="pointer-config">
                <input type="text" id="pointer-name" placeholder="æŒ‡é’ˆåç§°" value="i">
                <button class="btn btn-success" id="add-pointer">æ·»åŠ æŒ‡é’ˆ</button>
                <button class="btn btn-danger" id="remove-pointer">åˆ é™¤é€‰ä¸­æŒ‡é’ˆ</button>
                <button class="btn btn-outline" id="clear-pointers">æ¸…é™¤æ‰€æœ‰æŒ‡é’ˆ</button>
                <div class="pointer-status" id="pointer-status">å½“å‰é€‰ä¸­ï¼šæ—  | ä½ç½®ï¼š-</div>
            </div>
            <div class="pointer-config">
                <input type="number" id="target-value" placeholder="ç›®æ ‡å€¼" style="width: 90px;">
                <div class="pointer-status" id="target-status">ç›®æ ‡ï¼šæœªè®¾ç½®</div>
            </div>
            <div class="pointer-config">
                <select id="relation-mode" class="array-input" style="max-width: 200px;">
                    <option value="none">å…³ç³»é«˜äº®ï¼šå…³é—­</option>
                    <option value="two-sum">ä¸¤æ•°ä¹‹å’Œ = ç›®æ ‡</option>
                    <option value="three-sum">ä¸‰æ•°ä¹‹å’Œ = ç›®æ ‡</option>
                </select>
                <button class="btn btn-outline" id="clear-highlight">æ¸…é™¤é«˜äº®</button>
            </div>
            <div class="pointer-config">
                <button class="btn btn-outline" id="tpl-merge">æ¨¡æ¿ï¼šåˆå¹¶æœ‰åºæ•°ç»„</button>
                <button class="btn btn-outline" id="tpl-remove">æ¨¡æ¿ï¼šç§»é™¤å…ƒç´ </button>
                <button class="btn btn-outline" id="tpl-binary">æ¨¡æ¿ï¼šäºŒåˆ†æŸ¥æ‰¾</button>
                <button class="btn btn-outline" id="tpl-two-sum">æ¨¡æ¿ï¼šä¸¤æ•°ä¹‹å’Œ</button>
                <button class="btn btn-outline" id="tpl-three-sum">æ¨¡æ¿ï¼šä¸‰æ•°ä¹‹å’Œ</button>
                <button class="btn btn-outline" id="tpl-window">æ¨¡æ¿ï¼šæ»‘åŠ¨çª—å£</button>
                <button class="btn btn-outline" id="tpl-move-zeros">æ¨¡æ¿ï¼šç§»åŠ¨é›¶</button>
                <button class="btn btn-outline" id="tpl-remove-dup">æ¨¡æ¿ï¼šç§»é™¤é‡å¤é¡¹</button>
                <button class="btn btn-outline" id="tpl-reverse">æ¨¡æ¿ï¼šåè½¬æ•°ç»„</button>
            </div>
            <div class="pointer-config">
                <button class="btn btn-primary" id="record-step">è®°å½•å½“å‰çŠ¶æ€</button>
                <button class="btn btn-primary" id="take-snapshot">ç”Ÿæˆæ•°ç»„å¿«ç…§</button>
            </div>
            <div class="pointer-config">
                <button class="btn btn-outline" id="start-record">å¼€å§‹å½•åˆ¶</button>
                <button class="btn btn-outline" id="stop-record">åœæ­¢å½•åˆ¶</button>
                <button class="btn btn-primary" id="play-record">å›æ”¾å½•åˆ¶</button>
                <button class="btn btn-outline" id="step-prev">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-outline" id="step-next">ä¸‹ä¸€æ­¥</button>
                <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;">
                    å›æ”¾é€Ÿåº¦
                    <select id="play-speed" class="array-input" style="max-width:90px;">
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                </label>
            </div>
            <div class="pointer-config">
                <button class="btn btn-danger" id="clear-record">æ¸…ç©ºå½•åˆ¶</button>
                <button class="btn btn-outline" id="export-record">å¯¼å‡ºå½•åˆ¶</button>
                <button class="btn btn-outline" id="import-record">å¯¼å…¥å½•åˆ¶</button>
                <input type="file" id="import-record-file" accept="application/json" style="display:none;">
                <div class="pointer-status" id="record-status">å½•åˆ¶ï¼šæœªå¼€å§‹</div>
            </div>
            <div class="pointer-config">
                <button class="btn btn-outline" id="zoom-out">ç¼©å°</button>
                <button class="btn btn-outline" id="zoom-in">æ”¾å¤§</button>
                <button class="btn btn-outline" id="zoom-reset">é‡ç½®ç¼©æ”¾</button>
                <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;">
                    <input type="checkbox" id="toggle-target-highlight" checked>
                    ç›®æ ‡é«˜äº®
                </label>
                <label style="display:flex;align-items:center;gap:6px;font-size:0.8rem;">
                    <input type="checkbox" id="toggle-relation-highlight" checked>
                    å…³ç³»é«˜äº®
                </label>
            </div>
            </div>
        </div>
        <div style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:0.5rem;">
            <button class="toggle-pill" id="toggle-code-global">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                æŠ˜å ä»£ç åŒº
            </button>
        </div>
        <div class="layout">
            <div class="code-panel" id="code-panel">
                <div class="code-header">
                    <div class="code-actions">
                        <div style="display:flex;gap:6px;align-items:center;">
                            <span style="font-size:0.8rem;color:#666;">å­—ä½“</span>
                            <button class="btn btn-outline" id="code-font-dec">-</button>
                            <button class="btn btn-outline" id="code-font-inc">+</button>
                        </div>
                    </div>
                </div>
                <pre class="code-output line-numbers"><code id="code-highlight" class="language-javascript"></code></pre>
                <textarea id="code-input" class="code-editor" placeholder="ç²˜è´´æˆ–è¾“å…¥ä»£ç " style="opacity:0.2;"></textarea>
            </div>
            <div class="layout-divider" id="layout-divider"></div>
            <div id="content-area">


        <!-- å¯è§†åŒ–åŒºåŸŸ -->
        <div class="visualization">
            <div class="arrays-container" id="arrays-container">
                <!-- æ•°ç»„1å®¹å™¨ -->
                <div class="array-container active" data-array-id="1">
                    <div class="array-label">æ•°æ®1</div>
                </div>
                <!-- æ•°ç»„2å®¹å™¨ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                <div class="array-container" data-array-id="2">
                    <div class="array-label">æ•°æ®2</div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤è®°å½• -->
        <div class="steps">
            <h3>ğŸ“ ç®—æ³•æ­¥éª¤è®°å½•</h3>
            <ul class="step-list" id="step-list"></ul>
            <div class="snapshot" id="snapshot-container" style="display: none;"></div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ - ç§»åˆ°é¡µé¢åº•éƒ¨ -->
        <div class="usage-guide">
            <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>æ•°ç»„æ“ä½œ</strong>ï¼š
                    <ul>
                        <li>è¾“å…¥é€—å·åˆ†éš”çš„æ•°å­—ï¼ˆå¦‚1,3,5,7ï¼‰ï¼Œç‚¹å‡»ã€Œæ¸²æŸ“æ•°ç»„ã€ç”Ÿæˆå¯è§†åŒ–æ•°ç»„</li>
                        <li>æ”¯æŒå•æ•°ç»„/åŒæ•°ç»„/å¤šæ•°ç»„æ¨¡å¼åˆ‡æ¢ï¼Œå¯åŠ¨æ€æ·»åŠ /åˆ é™¤æ•°ç»„åŠæ•°ç»„å…ƒç´ </li>
                        <li>ç‚¹å‡»æ•°ç»„å…ƒç´ è¾“å…¥æ¡†å¯ç›´æ¥ä¿®æ”¹æ•°å€¼ï¼Œå®æ—¶åŒæ­¥</li>
                    </ul>
                </li>
                <li><strong>æŒ‡é’ˆæ“ä½œ</strong>ï¼š
                    <ul>
                        <li>æ·»åŠ æŒ‡é’ˆï¼šè‡ªåŠ¨é»˜è®¤i/j/kå‘½åï¼Œç‚¹å‡»ã€Œæ·»åŠ æŒ‡é’ˆã€ï¼Œæ¯ä¸ªæŒ‡é’ˆè‡ªåŠ¨åˆ†é…å”¯ä¸€é¢œè‰²</li>
                        <li>é€‰ä¸­æŒ‡é’ˆï¼šç‚¹å‡»æŒ‡é’ˆå³å¯é€‰ä¸­ï¼ˆé«˜äº®æ”¾å¤§ï¼‰ï¼Œä¸€æ¬¡ä»…èƒ½é€‰ä¸­ä¸€ä¸ªæŒ‡é’ˆ</li>
                        <li>é”®ç›˜æ§åˆ¶ï¼š
                            <ul>
                                <li>â† â†’ æ–¹å‘é”®ï¼šæ§åˆ¶é€‰ä¸­æŒ‡é’ˆåœ¨å½“å‰æ•°ç»„ä¸­å·¦å³ç§»åŠ¨ï¼ˆåˆ‡æ¢æŒ‡å‘çš„ç´¢å¼•ï¼‰</li>
                                <li>â†‘ æ–¹å‘é”®ï¼šæŒ‡é’ˆåœ¨å½“å‰æ•°ç»„å†…åˆ‡æ¢ä½ç½®ï¼ˆä¸‹æ–¹â†’ä¸Šæ–¹ï¼‰â†’ å¤šæ•°ç»„æ¨¡å¼ä¸‹å†æŒ‰åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæ•°ç»„</li>
                                <li>â†“ æ–¹å‘é”®ï¼šæŒ‡é’ˆåœ¨å½“å‰æ•°ç»„å†…åˆ‡æ¢ä½ç½®ï¼ˆä¸Šæ–¹â†’ä¸‹æ–¹ï¼‰â†’ å¤šæ•°ç»„æ¨¡å¼ä¸‹å†æŒ‰åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ•°ç»„</li>
                            </ul>
                        </li>
                        <li>åˆ é™¤æŒ‡é’ˆï¼šé€‰ä¸­æŒ‡é’ˆåç‚¹å‡»ã€Œåˆ é™¤é€‰ä¸­æŒ‡é’ˆã€ï¼Œæˆ–åŒå‡»æŒ‡é’ˆï¼Œæˆ–æŒ‰ Delete/Backspace</li>
                    </ul>
                </li>
                <li><strong>å¿«æ·é”®</strong>ï¼š
                    <ul>
                        <li>Ctrl+Eï¼šç¼–è¾‘å½“å‰ç„¦ç‚¹æˆå‘˜ï¼ˆæœ‰æŒ‡é’ˆæ—¶ä¸ºæŒ‡é’ˆæ‰€æŒ‡æˆå‘˜ï¼‰</li>
                        <li>Ctrl+Dï¼šåˆ é™¤å½“å‰ç„¦ç‚¹æˆå‘˜ï¼ˆæœ‰æŒ‡é’ˆæ—¶ä¸ºæŒ‡é’ˆæ‰€æŒ‡æˆå‘˜ï¼‰</li>
                        <li>Ctrl+Pï¼šåœ¨æ•°ç»„å‰æ–¹æ·»åŠ æˆå‘˜å¹¶é‡æ’ç´¢å¼•</li>
                        <li>Ctrl+Aï¼šåœ¨æ•°ç»„åæ–¹æ·»åŠ æˆå‘˜å¹¶é‡æ’ç´¢å¼•</li>
                        <li>Escï¼šæŠ˜å /å±•å¼€åŠŸèƒ½æŒ‰é’®åŒº</li>
                        <li>åŒå‡»æ•°ç»„æˆå‘˜ï¼šä¸ºè¯¥æˆå‘˜æ·»åŠ æ–°æŒ‡é’ˆ</li>
                        <li>åŒå‡»æŒ‡é’ˆï¼šåˆ é™¤è¯¥æŒ‡é’ˆ</li>
                    </ul>
                </li>
                <li><strong>æ¨æ¼”è¾…åŠ©</strong>ï¼š
                    <ul>
                        <li>è®°å½•æ­¥éª¤ï¼šç‚¹å‡»ã€Œè®°å½•å½“å‰çŠ¶æ€ã€ä¿å­˜å½“å‰æ•°ç»„å’ŒæŒ‡é’ˆä½ç½®</li>
                        <li>ç”Ÿæˆå¿«ç…§ï¼šç‚¹å‡»ã€Œç”Ÿæˆæ•°ç»„å¿«ç…§ã€å¯¼å‡ºå®Œæ•´çš„æ•°ç»„å’ŒæŒ‡é’ˆä¿¡æ¯</li>
                        <li>æ¸…ç©ºæ‰€æœ‰ï¼šä¸€é”®é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆæ•°ç»„ã€æŒ‡é’ˆã€æ­¥éª¤ï¼‰</li>
                    </ul>
                </li>
            </ul>
        </div>
            </div>
        </div>
    </div>

    <script>
        const codePanel = document.getElementById('code-panel');
        const layoutEl = document.querySelector('.layout');
        const dividerEl = document.getElementById('layout-divider');
        const toggleCodeGlobalBtn = document.getElementById('toggle-code-global');
        const codeInputEl = document.getElementById('code-input');
        const codeHighlightEl = document.getElementById('code-highlight');
        const codeOutputPre = document.querySelector('.code-output');
        const fontDecBtn = document.getElementById('code-font-dec');
        const fontIncBtn = document.getElementById('code-font-inc');
        (function initCodeFontSize(){
            let fs = Number(localStorage.getItem('arraytool_code_fontsize_rem'));
            if (!Number.isFinite(fs)) fs = 0.7;
            if (codeOutputPre) codeOutputPre.style.fontSize = fs + 'rem';
            function apply(fs2) {
                fs = Math.min(1.0, Math.max(0.55, fs2));
                if (codeOutputPre) codeOutputPre.style.fontSize = fs + 'rem';
                localStorage.setItem('arraytool_code_fontsize_rem', String(fs));
            }
            if (fontDecBtn) fontDecBtn.addEventListener('click', () => apply(fs - 0.05));
            if (fontIncBtn) fontIncBtn.addEventListener('click', () => apply(fs + 0.05));
        })();
        function showCode(lang, src) {
            try {
                codeHighlightEl.className = 'language-' + lang;
                codeHighlightEl.textContent = src || '';
                if (window.Prism) Prism.highlightElement(codeHighlightEl);
            } catch (_) {}
        }
        const templateDart = {
            mergeSorted:
`List<int> merge(List<int> a, List<int> b) {
  int i=0,j=0;
  List<int> r=[];
  while(i<a.length && j<b.length){
    if(a[i]<=b[j]){ r.add(a[i]); i++; } else { r.add(b[j]); j++; }
  }
  while(i<a.length){ r.add(a[i]); i++; }
  while(j<b.length){ r.add(b[j]); j++; }
  return r;
}`,
            removeElement:
`int removeElement(List<int> nums, int val) {
  int k=0;
  for(int i=0;i<nums.length;i++){
    if(nums[i]!=val){ nums[k]=nums[i]; k++; }
  }
  return k;
}`,
            binarySearch:
`int binarySearch(List<int> nums,int target){
  int l=0,r=nums.length-1;
  while(l<=r){
    int m=(l+r)>>1;
    if(nums[m]==target) return m;
    if(nums[m]<target) l=m+1; else r=m-1;
  }
  return -1;
}`,
            twoSum:
`List<int> twoSumSorted(List<int> nums,int target){
  int l=0,r=nums.length-1;
  while(l<r){
    int s=nums[l]+nums[r];
    if(s==target) return [l,r];
    if(s<target) l++; else r--;
  }
  return [];
}`,
            threeSum:
`List<List<int>> threeSum(List<int> nums){
  nums.sort();
  List<List<int>> res=[];
  for(int i=0;i<nums.length;i++){
    if(i>0 && nums[i]==nums[i-1]) continue;
    int l=i+1,r=nums.length-1;
    while(l<r){
      int s=nums[i]+nums[l]+nums[r];
      if(s==0){
        res.add([nums[i],nums[l],nums[r]]);
        l++; r--;
        while(l<r && nums[l]==nums[l-1]) l++;
        while(l<r && nums[r]==nums[r+1]) r--;
      } else if(s<0){ l++; } else { r--; }
    }
  }
  return res;
}`,
            slidingWindow:
`int maxSumOfSizeK(List<int> nums,int k){
  int sum=0,best=0;
  for(int i=0;i<nums.length;i++){
    sum+=nums[i];
    if(i>=k){ sum-=nums[i-k]; }
    if(i>=k-1 && sum>best) best=sum;
  }
  return best;
}`,
            moveZeros:
`void moveZeroes(List<int> nums){
  int k=0;
  for(int i=0;i<nums.length;i++){
    if(nums[i]!=0){ nums[k]=nums[i]; k++; }
  }
  for(int i=k;i<nums.length;i++) nums[i]=0;
}`,
            removeDuplicates:
`int removeDuplicates(List<int> nums){
  if(nums.isEmpty) return 0;
  int k=1;
  for(int i=1;i<nums.length;i++){
    if(nums[i]!=nums[k-1]){ nums[k]=nums[i]; k++; }
  }
  return k;
}`,
            reverseArray:
`void reverse(List<int> nums){
  int l=0,r=nums.length-1;
  while(l<r){
    int t=nums[l]; nums[l]=nums[r]; nums[r]=t;
    l++; r--;
  }
}`
        };
        function updateHighlight(text) {
            codeHighlightEl.textContent = text || '';
            if (window.Prism) Prism.highlightElement(codeHighlightEl);
        }
        async function getClipboardText() {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const t = await navigator.clipboard.readText();
                    if (typeof t === 'string' && t.trim().length && t !== '[object Promise]') return t;
                }
            } catch (_) {}
            try {
                if (navigator.clipboard && navigator.clipboard.read) {
                    const items = await navigator.clipboard.read();
                    for (const item of items) {
                        if (item.types && item.types.length) {
                            const type = item.types.includes('text/plain') ? 'text/plain' : item.types[0];
                            const blob = await item.getType(type);
                            const txt = await blob.text();
                            if (typeof txt === 'string' && txt.trim().length && txt !== '[object Promise]') return txt;
                        }
                    }
                }
            } catch (_) {}
            return null;
        }
        async function pasteFromClipboard() {
            try {
                if (navigator.clipboard && navigator.clipboard.readText) {
                    const txt = await navigator.clipboard.readText();
                    if (txt && txt.length && txt !== '[object Promise]') {
                        codeInputEl.value = txt;
                        autoFormat();
                        return;
                    }
                }
            } catch (_) {}
            try {
                codeInputEl.focus();
            } catch (_) {}
            showManualPasteOverlay();
        }
        function autoFormat() {
            try {
                const src = codeInputEl.value || '';
                const formatted = window.prettier.format(src, { parser: 'babel', plugins: [window.prettierPlugins.babel] });
                codeInputEl.value = formatted;
                updateHighlight(formatted);
            } catch (_) {
                updateHighlight(codeInputEl.value || '');
            }
        }
        function showManualPasteOverlay() {
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.background = 'rgba(0,0,0,0.35)';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '9999';
            const box = document.createElement('div');
            box.style.background = '#fff';
            box.style.border = '1px solid #e5e7eb';
            box.style.borderRadius = '10px';
            box.style.width = '520px';
            box.style.maxWidth = '92vw';
            box.style.padding = '12px';
            box.style.boxShadow = '0 10px 25px rgba(0,0,0,0.15)';
            const title = document.createElement('div');
            title.textContent = 'ç²˜è´´ä»£ç ';
            title.style.fontSize = '14px';
            title.style.fontWeight = '600';
            title.style.marginBottom = '8px';
            const ta = document.createElement('textarea');
            ta.style.width = '100%';
            ta.style.height = '120px';
            ta.style.border = '1px solid #ddd';
            ta.style.borderRadius = '8px';
            ta.style.padding = '8px';
            ta.style.fontSize = '13px';
            ta.style.fontFamily = 'Consolas, monospace';
            ta.placeholder = 'åœ¨æ­¤å¤„æŒ‰ âŒ˜V / Ctrl+V ç²˜è´´ä»£ç ';
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.justifyContent = 'flex-end';
            actions.style.gap = '8px';
            actions.style.marginTop = '10px';
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline';
            cancelBtn.textContent = 'å–æ¶ˆ';
            const okBtn = document.createElement('button');
            okBtn.className = 'btn btn-primary';
            okBtn.textContent = 'ç¡®å®š';
            actions.appendChild(cancelBtn);
            actions.appendChild(okBtn);
            box.appendChild(title);
            box.appendChild(ta);
            box.appendChild(actions);
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            function close() {
                overlay.remove();
            }
            cancelBtn.addEventListener('click', close);
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) close();
            });
            okBtn.addEventListener('click', () => {
                const val = ta.value || '';
                if (val.length) {
                    codeInputEl.value = val;
                    autoFormat();
                }
                close();
            });
            ta.addEventListener('paste', (e) => {
                setTimeout(() => {
                    const val = ta.value || '';
                    if (val.length) {
                        codeInputEl.value = val;
                        autoFormat();
                        close();
                    }
                }, 0);
            });
            ta.focus();
        }
        if (toggleCodeGlobalBtn) {
            toggleCodeGlobalBtn.addEventListener('click', () => {
                const collapsed = codePanel.classList.toggle('collapsed');
                toggleCodeGlobalBtn.innerHTML = `${toggleCodeGlobalBtn.innerHTML.replace(/(å±•å¼€|æŠ˜å )ä»£ç åŒº/, collapsed ? 'å±•å¼€ä»£ç åŒº' : 'æŠ˜å ä»£ç åŒº')}`;
                // ä¸å†åˆ‡æ¢å¸ƒå±€çš„collapsedï¼Œé¿å…å†…å®¹åŒºå—å½±å“
            });
        }
        (function() {
            let leftWidth = Number(localStorage.getItem('arraytool_left_width'));
            if (!Number.isFinite(leftWidth) || leftWidth < 280) leftWidth = 520;
            if (layoutEl) layoutEl.style.setProperty('--left-width', leftWidth + 'px');
            if (!dividerEl) return;
            let dragging = false;
            let startX = 0;
            let startW = leftWidth;
            function onMove(e) {
                if (!dragging) return;
                const rect = layoutEl.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const minLeft = 280;
                const maxLeft = Math.max(minLeft, rect.width - 320);
                const w = Math.max(minLeft, Math.min(maxLeft, x));
                layoutEl.style.setProperty('--left-width', w + 'px');
            }
            function onUp() {
                if (!dragging) return;
                dragging = false;
                const val = layoutEl.style.getPropertyValue('--left-width').replace('px','');
                const num = Number(val);
                if (Number.isFinite(num)) localStorage.setItem('arraytool_left_width', String(num));
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
            dividerEl.addEventListener('mousedown', (e) => {
                if (layoutEl && layoutEl.classList.contains('collapsed')) return;
                dragging = true;
                startX = e.clientX;
                startW = Number((layoutEl.style.getPropertyValue('--left-width') || '520px').replace('px',''));
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
        })();
        codeInputEl.addEventListener('input', () => updateHighlight(codeInputEl.value));
        function parseCodeToData(src) {
            let payload = null;
            try {
                const trimmed = src.trim();
                if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
                    payload = JSON.parse(trimmed);
                }
            } catch (_) {}
            if (!payload) {
                const arrays = [];
                const names = [];
                const re = /(?:const|let|var)\s+([A-Za-z_]\w*)\s*=\s*\[([\s\S]*?)\]/g;
                let m;
                while ((m = re.exec(src)) !== null) {
                    const varName = m[1];
                    const raw = m[2];
                    const items = raw.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    arrays.push(items);
                    names.push(varName);
                }
                if (arrays.length) {
                    payload = { arrays, names };
                }
            }
            return payload;
        }
        function applyParsedData(payload) {
            if (!payload) return;
            if (Array.isArray(payload.arrays) && payload.arrays.length) {
                const arrs = payload.arrays;
                // ç¡®ä¿è¶³å¤Ÿçš„æ•°ç»„è¾“å…¥ä¸å®¹å™¨
                while (maxArrayId < arrs.length) { addNewArray(); }
                // è®¾ç½®æ•°ç»„åç§°ï¼ˆå¯é€‰ï¼‰
                if (Array.isArray(payload.names)) {
                    payload.names.forEach((nm, i) => { setArrayName(i + 1, nm); });
                }
                // å†™å…¥è¾“å…¥æ¡†
                arrs.forEach((a, i) => {
                    const id = i + 1;
                    const input = document.querySelector(`.array-input[data-array-id="${id}"]`);
                    if (input) {
                        input.value = a.join(',');
                    }
                });
                // åˆ‡æ¢æ¨¡å¼
                const mode = arrs.length === 1 ? 'single' : (arrs.length === 2 ? 'double' : 'multi');
                switchMode(mode);
            }
            if (Array.isArray(payload.pointers)) {
                clearPointers();
                payload.pointers.forEach(p => {
                    if (p && p.name && Number.isFinite(Number(p.arrayId)) && Number.isFinite(Number(p.index))) {
                        addPointerWith(p.name, Number(p.arrayId), Number(p.index), p.pos || p.position || 'bottom');
                    }
                });
            }
            if (payload.target !== undefined) {
                const v = Number(payload.target);
                const targetInput = document.getElementById('target-value');
                if (targetInput) {
                    targetInput.value = Number.isFinite(v) ? String(v) : '';
                    updateTargetFromInput();
                }
            }
            if (payload.relationMode) {
                const relationModeSelect = document.getElementById('relation-mode');
                if (relationModeSelect) {
                    relationModeSelect.value = payload.relationMode;
                    relationMode = relationModeSelect.value;
                    updateRelationHighlight();
                    updateTargetStats();
                }
            }
            renderArray();
        }
        // å…¨å±€å˜é‡
        let currentArrays = {
            1: []
        };
        let currentMode = 'single'; // single/double/multi
        let pointers = []; // å­˜å‚¨æŒ‡é’ˆä¿¡æ¯ {id, name, element, arrayId, index, color, positionType: 'top'/'bottom'}
        let selectedPointer = null;
        let maxArrayId = 1; // è®°å½•æœ€å¤§æ•°ç»„ID
        let targetValue = null; // ç›®æ ‡å€¼ç”¨äºé«˜äº®
        let relationMode = 'none';
        let isRecording = false;
        let recordLog = [];
        let playbackTimer = null;
        let playbackIndex = 0;
        let arrayNames = {}; // { arrayId: name }
        let playbackSpeed = 1;
        const PLAYBACK_BASE_DELAY = 300;
        let enableTargetHighlight = true;
        let enableRelationHighlight = true;
        let zoomScale = 1;
        const ZOOM_STEP = 0.1;
        const ZOOM_MIN = 0.5;
        const ZOOM_MAX = 2;
        let focusedItem = null; // { arrayId, index }
        
        // æŒ‡é’ˆé¢œè‰²æ± ï¼ˆæ›´é…·çš„é…è‰²ï¼‰
        const pointerColors = [
            'rgba(230, 57, 70, 0.8)',   // çº¢
            'rgba(15, 52, 96, 0.8)',    // æ·±è“
            'rgba(22, 199, 154, 0.8)',  // ç»¿
            'rgba(142, 36, 170, 0.8)',  // ç´«
            'rgba(255, 159, 67, 0.8)',  // æ©™
            'rgba(59, 130, 246, 0.8)',  // äº®è“
            'rgba(107, 114, 128, 0.8)'  // ç°
        ];
        let colorIndex = 0;
        // é»˜è®¤æŒ‡é’ˆå‘½ååºåˆ—
        const defaultPointerNames = ['i', 'j', 'k'];

        // DOMå…ƒç´ 
        const singleModeBtn = document.getElementById('single-mode');
        const doubleModeBtn = document.getElementById('double-mode');
        const multiModeBtn = document.getElementById('multi-mode');
        const arrayInputsContainer = document.getElementById('array-inputs-container');
        const arraysContainer = document.getElementById('arrays-container');
        const renderArrayBtn = document.getElementById('render-array');
        const addArrayBtn = document.getElementById('add-array');
        const removeArrayBtn = document.getElementById('remove-array');
        const addArrayItemBtn = document.getElementById('add-array-item');
        const removeArrayItemBtn = document.getElementById('remove-array-item');
        const clearAllBtn = document.getElementById('clear-all');
        const pointerNameInput = document.getElementById('pointer-name');
        const addPointerBtn = document.getElementById('add-pointer');
        const removePointerBtn = document.getElementById('remove-pointer');
        const clearPointersBtn = document.getElementById('clear-pointers');
        const pointerStatus = document.getElementById('pointer-status');
        const recordStepBtn = document.getElementById('record-step');
        const takeSnapshotBtn = document.getElementById('take-snapshot');
        const targetInput = document.getElementById('target-value');
        const targetStatus = document.getElementById('target-status');
        const relationModeSelect = document.getElementById('relation-mode');
        const clearHighlightBtn = document.getElementById('clear-highlight');
        const tplMergeBtn = document.getElementById('tpl-merge');
        const tplRemoveBtn = document.getElementById('tpl-remove');
        const tplBinaryBtn = document.getElementById('tpl-binary');
        const tplTwoSumBtn = document.getElementById('tpl-two-sum');
        const tplThreeSumBtn = document.getElementById('tpl-three-sum');
        const tplWindowBtn = document.getElementById('tpl-window');
        const tplMoveZerosBtn = document.getElementById('tpl-move-zeros');
        const tplRemoveDupBtn = document.getElementById('tpl-remove-dup');
        const tplReverseBtn = document.getElementById('tpl-reverse');
        const toggleControlsBtn = document.getElementById('toggle-controls');
        const startRecordBtn = document.getElementById('start-record');
        const stopRecordBtn = document.getElementById('stop-record');
        const playRecordBtn = document.getElementById('play-record');
        const stepPrevBtn = document.getElementById('step-prev');
        const stepNextBtn = document.getElementById('step-next');
        const playSpeedSelect = document.getElementById('play-speed');
        const clearRecordBtn = document.getElementById('clear-record');
        const exportRecordBtn = document.getElementById('export-record');
        const importRecordBtn = document.getElementById('import-record');
        const importRecordFile = document.getElementById('import-record-file');
        const recordStatus = document.getElementById('record-status');
        const stepList = document.getElementById('step-list');
        const snapshotContainer = document.getElementById('snapshot-container');
        const visualization = document.querySelector('.visualization');
        const contentArea = document.getElementById('content-area');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomResetBtn = document.getElementById('zoom-reset');
        const toggleTargetHighlight = document.getElementById('toggle-target-highlight');
        const toggleRelationHighlight = document.getElementById('toggle-relation-highlight');
        let activeArrayId = 1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderArray(); // åˆå§‹æ¸²æŸ“
            bindEvents();
            updatePointerStatus();
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°å®šä½æŒ‡é’ˆ
            window.addEventListener('resize', repositionPointers);
            // åˆå§‹åŒ–é»˜è®¤æŒ‡é’ˆåç§°
            updateDefaultPointerName();
            if (contentArea) {
                contentArea.tabIndex = 0;
            }
            let maxId = 1;
            document.querySelectorAll('.array-container').forEach(c => {
                const id = Number(c.dataset.arrayId);
                if (Number.isFinite(id) && id > maxId) maxId = id;
                if (id === 1) {
                    c.classList.add('active');
                    c.classList.add('selected');
                } else {
                    c.classList.remove('active');
                    c.classList.remove('selected');
                }
            });
            document.querySelectorAll('.array-input-wrapper').forEach(w => {
                const id = Number(w.dataset.arrayId);
                if (id === 1) w.classList.add('active'); else w.classList.remove('active');
            });
            activeArrayId = 1;
            maxArrayId = maxId;
        });

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ¨¡å¼åˆ‡æ¢
            singleModeBtn.addEventListener('click', () => switchMode('single'));
            doubleModeBtn.addEventListener('click', () => switchMode('double'));
            multiModeBtn.addEventListener('click', () => switchMode('multi'));
            
            // æ¸²æŸ“æ•°ç»„
            renderArrayBtn.addEventListener('click', renderArray);
            
            // å¤šæ•°ç»„æ§åˆ¶
            addArrayBtn.addEventListener('click', addNewArray);
            removeArrayBtn.addEventListener('click', removeLastArray);
            
            // åŠ¨æ€å¢åˆ æ•°ç»„å…ƒç´ 
            addArrayItemBtn.addEventListener('click', addArrayItem);
            removeArrayItemBtn.addEventListener('click', removeArrayItem);
            
            // æ¸…ç©ºæ‰€æœ‰
            clearAllBtn.addEventListener('click', clearAll);
            
            // æ·»åŠ æŒ‡é’ˆ
            addPointerBtn.addEventListener('click', addPointer);
            
            // åˆ é™¤æŒ‡é’ˆ
            removePointerBtn.addEventListener('click', removeSelectedPointer);
            // æ¸…é™¤æ‰€æœ‰æŒ‡é’ˆ
            clearPointersBtn.addEventListener('click', clearPointers);
            
            // è®°å½•æ­¥éª¤
            recordStepBtn.addEventListener('click', recordStep);
            
            // ç”Ÿæˆå¿«ç…§
            takeSnapshotBtn.addEventListener('click', takeSnapshot);

            // ç›®æ ‡å€¼è¾“å…¥
            targetInput.addEventListener('input', updateTargetFromInput);

            // å…³ç³»æ¨¡å¼åˆ‡æ¢
            relationModeSelect.addEventListener('change', () => {
                relationMode = relationModeSelect.value;
                updateRelationHighlight();
                updateTargetStats();
            });

            // æ¸…é™¤é«˜äº®
            clearHighlightBtn.addEventListener('click', () => {
                targetValue = null;
                targetInput.value = '';
                targetStatus.textContent = 'ç›®æ ‡ï¼šæœªè®¾ç½®';
                clearAllRelationHighlights();
                updateTargetHighlight();
                updateTargetStats();
            });

            // æ¨¡æ¿æŒ‰é’®
            tplMergeBtn.addEventListener('click', applyTemplateMergeSorted);
            tplRemoveBtn.addEventListener('click', applyTemplateRemoveElement);
            tplBinaryBtn.addEventListener('click', applyTemplateBinarySearch);
            tplTwoSumBtn.addEventListener('click', applyTemplateTwoSum);
            tplThreeSumBtn.addEventListener('click', applyTemplateThreeSum);
            tplWindowBtn.addEventListener('click', applyTemplateSlidingWindow);
            tplMoveZerosBtn.addEventListener('click', applyTemplateMoveZeros);
            tplRemoveDupBtn.addEventListener('click', applyTemplateRemoveDuplicates);
            tplReverseBtn.addEventListener('click', applyTemplateReverseArray);
            toggleControlsBtn.addEventListener('click', toggleControlsArea);
            startRecordBtn.addEventListener('click', startRecording);
            stopRecordBtn.addEventListener('click', stopRecording);
            playRecordBtn.addEventListener('click', playRecording);
            stepPrevBtn.addEventListener('click', () => stepPlayback(-1));
            stepNextBtn.addEventListener('click', () => stepPlayback(1));
            playSpeedSelect.addEventListener('change', () => {
                const v = Number(playSpeedSelect.value);
                playbackSpeed = Number.isFinite(v) && v > 0 ? v : 1;
            });
            clearRecordBtn.addEventListener('click', clearRecording);
            exportRecordBtn.addEventListener('click', exportRecording);
            importRecordBtn.addEventListener('click', () => importRecordFile.click());
            importRecordFile.addEventListener('change', handleImportRecording);
            zoomInBtn.addEventListener('click', () => {
                zoomScale = Math.min(ZOOM_MAX, zoomScale + ZOOM_STEP);
                applyZoom();
            });
            zoomOutBtn.addEventListener('click', () => {
                zoomScale = Math.max(ZOOM_MIN, zoomScale - ZOOM_STEP);
                applyZoom();
            });
            zoomResetBtn.addEventListener('click', () => {
                zoomScale = 1;
                applyZoom();
            });
            if (toggleTargetHighlight) {
                toggleTargetHighlight.addEventListener('change', () => {
                    enableTargetHighlight = toggleTargetHighlight.checked;
                    updateTargetHighlight();
                });
            }
            if (toggleRelationHighlight) {
                toggleRelationHighlight.addEventListener('change', () => {
                    enableRelationHighlight = toggleRelationHighlight.checked;
                    updateRelationHighlight();
                });
            }
            
            // ç›‘å¬æ•°ç»„å…ƒç´ ä¿®æ”¹
            arraysContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('array-value')) {
                    updateArrayValue(e);
                }
            });
            arraysContainer.addEventListener('click', (e) => {
                const c = e.target.closest('.array-container');
                if (c && c.dataset.arrayId) {
                    activeArrayId = Number(c.dataset.arrayId);
                    document.querySelectorAll('.array-container').forEach(el => el.classList.remove('selected'));
                    c.classList.add('selected');
                    document.querySelectorAll('.array-input-wrapper').forEach(w => {
                        if (Number(w.dataset.arrayId) === activeArrayId) w.classList.add('active');
                        else w.classList.remove('active');
                    });
                    renderArray();
                }
            });
            if (contentArea) {
                contentArea.addEventListener('keydown', (e) => {
                    const key = (e.key || '').toLowerCase();
                    if (e.ctrlKey && e.metaKey && key === 'a') {
                        e.preventDefault();
                        addNewArray();
                        return;
                    }
                    if (e.ctrlKey && e.metaKey && key === 'd') {
                        e.preventDefault();
                        removeArrayById(activeArrayId);
                        return;
                    }
                });
            }

            // é”®ç›˜æ§åˆ¶æŒ‡é’ˆä¸æ— æŒ‡é’ˆæ—¶çš„èšç„¦ç§»åŠ¨
        document.addEventListener('keydown', (e) => {
            const k = e.key && e.key.toLowerCase();
                if (k && k.length === 1) {
                    const p = pointers.find(pp => pp.name.toLowerCase() === k);
                    if (p) {
                        selectPointer(p);
                        updatePointerStatus();
                        updateArrayItemHighlight();
                        e.preventDefault();
                        return;
                    }
                }
                // æ— æŒ‡é’ˆæ—¶ï¼Œä½¿ç”¨å·¦å³æ–¹å‘é”®åœ¨å½“å‰æ•°ç»„ä¸­ç§»åŠ¨èšç„¦æˆå‘˜
                if (!selectedPointer && pointers.length === 0) {
                    if (e.keyCode === 37 || e.keyCode === 39) {
                        e.preventDefault();
                        const aid = (focusedItem && focusedItem.arrayId) ? focusedItem.arrayId : (activeArrayId || 1);
                        const arr = currentArrays[aid] || [];
                        if (!arr.length) return;
                        let idx = (focusedItem && typeof focusedItem.index === 'number') ? focusedItem.index : 0;
                        if (e.keyCode === 37) idx = Math.max(0, idx - 1);
                        if (e.keyCode === 39) idx = Math.min(arr.length - 1, idx + 1);
                        const itemEl = document.querySelector(`.array-container[data-array-id="${aid}"] .array-item[data-index="${idx}"]`);
                        if (itemEl) setFocusedItem(aid, idx, itemEl);
                        return;
                    }
                    // æ— æŒ‡é’ˆæ—¶ï¼Œä¸å¤„ç†ä¸Šä¸‹æ–¹å‘é”®
                }
                // æœ‰é€‰ä¸­æŒ‡é’ˆæ—¶ï¼Œæ–¹å‘é”®ç§»åŠ¨æŒ‡é’ˆ
                if (selectedPointer) {
                    if ([37, 38, 39, 40].includes(e.keyCode)) {
                        e.preventDefault();
                    }
                    switch(e.keyCode) {
                        case 37:
                            movePointer(selectedPointer, 'left');
                            break;
                        case 39:
                            movePointer(selectedPointer, 'right');
                            break;
                        case 38:
                            movePointer(selectedPointer, 'up');
                            break;
                        case 40:
                            movePointer(selectedPointer, 'down');
                            break;
                    }
                }
            });

            // å…¨å±€å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { toggleControlsArea(); return; }
            if (e.ctrlKey && !e.metaKey && e.key.toLowerCase() === 'e') { e.preventDefault(); focusEditFocusedItem(); return; }
            if (e.ctrlKey && !e.metaKey && e.key.toLowerCase() === 'p') { e.preventDefault(); addArrayItem(); return; }
            if (e.ctrlKey && !e.metaKey && e.key.toLowerCase() === 'a') { e.preventDefault(); addArrayItem(); return; }
            if (e.ctrlKey && !e.metaKey && e.key.toLowerCase() === 'd') { e.preventDefault(); removeArrayItem(); return; }
            if ((e.key === 'Delete' || e.key === 'Backspace') && selectedPointer) { e.preventDefault(); removeSelectedPointer(); return; }
        });
        }

        // æ›´æ–°é»˜è®¤æŒ‡é’ˆåç§°ï¼ˆiâ†’jâ†’kå¾ªç¯ï¼‰
        function updateDefaultPointerName() {
            let nextName = 'i';
            // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœªä½¿ç”¨çš„é»˜è®¤åç§°
            for (const name of defaultPointerNames) {
                const exists = pointers.some(p => p.name === name);
                if (!exists) {
                    nextName = name;
                    break;
                }
            }
            // å¦‚æœi/j/kéƒ½è¢«ä½¿ç”¨äº†ï¼Œç»§ç»­å¾€åå‘½åï¼ˆå¦‚l,m,n...ï¼‰
            if (pointers.some(p => p.name === 'i') && 
                pointers.some(p => p.name === 'j') && 
                pointers.some(p => p.name === 'k')) {
                let charCode = 108; // 'l'çš„ASCIIç 
                while (pointers.some(p => p.name === String.fromCharCode(charCode))) {
                    charCode++;
                }
                nextName = String.fromCharCode(charCode);
            }
            pointerNameInput.value = nextName;
        }

        // åˆ‡æ¢æ•°ç»„æ¨¡å¼
        function switchMode(mode) {
            currentMode = 'multi';
            showAllArrays();
            renderArray();
        }

        // åªæ˜¾ç¤ºæŒ‡å®šæ•°ç»„
        function showOnlyArray(arrayId) {
            // éšè—æ‰€æœ‰æ•°ç»„è¾“å…¥å’Œå®¹å™¨
            document.querySelectorAll('.array-input-wrapper').forEach(wrapper => {
                wrapper.classList.remove('active');
            });
            document.querySelectorAll('.array-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šæ•°ç»„
            const inputWrapper = document.querySelector(`.array-input-wrapper[data-array-id="${arrayId}"]`);
            const arrayContainer = document.querySelector(`.array-container[data-array-id="${arrayId}"]`);
            if (inputWrapper) inputWrapper.classList.add('active');
            if (arrayContainer) arrayContainer.classList.add('active');
        }

        // æ˜¾ç¤ºæŒ‡å®šæ•°ç»„åˆ—è¡¨
        function showArrays(arrayIds) {
            // éšè—æ‰€æœ‰æ•°ç»„è¾“å…¥å’Œå®¹å™¨
            document.querySelectorAll('.array-input-wrapper').forEach(wrapper => {
                wrapper.classList.remove('active');
            });
            document.querySelectorAll('.array-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šæ•°ç»„
            arrayIds.forEach(id => {
                const inputWrapper = document.querySelector(`.array-input-wrapper[data-array-id="${id}"]`);
                const arrayContainer = document.querySelector(`.array-container[data-array-id="${id}"]`);
                if (inputWrapper) inputWrapper.classList.add('active');
                if (arrayContainer) arrayContainer.classList.add('active');
            });
        }

        // æ˜¾ç¤ºæ‰€æœ‰æ•°ç»„
        function showAllArrays() {
            // æ˜¾ç¤ºæ‰€æœ‰æ•°ç»„è¾“å…¥å’Œå®¹å™¨
            document.querySelectorAll('.array-input-wrapper').forEach(wrapper => {
                wrapper.classList.add('active');
            });
            document.querySelectorAll('.array-container').forEach(container => {
                container.classList.add('active');
            });
        }

        // æ·»åŠ æ–°æ•°ç»„
        function addNewArray() {
            maxArrayId++;
            currentArrays[maxArrayId] = [];
            
            // åˆ›å»ºæ•°ç»„è¾“å…¥æ¡†
            createArrayInput(maxArrayId);
            // åˆ›å»ºæ•°ç»„å®¹å™¨
            createArrayContainer(maxArrayId);
            
            // æ˜¾ç¤ºå¹¶é€‰ä¸­æ–°æ•°ç»„
            const inputWrapper = document.querySelector(`.array-input-wrapper[data-array-id="${maxArrayId}"]`);
            const arrayContainer = document.querySelector(`.array-container[data-array-id="${maxArrayId}"]`);
            if (inputWrapper) inputWrapper.classList.add('active');
            if (arrayContainer) {
                arrayContainer.classList.add('active');
                document.querySelectorAll('.array-container').forEach(el => el.classList.remove('selected'));
                arrayContainer.classList.add('selected');
            }
            activeArrayId = maxArrayId;
            
            renderArray();
        }

        // åˆ›å»ºæ•°ç»„è¾“å…¥æ¡†
        function createArrayInput(arrayId) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.querySelector(`.array-input-wrapper[data-array-id="${arrayId}"]`)) {
                return;
            }
            
            const wrapper = document.createElement('div');
            wrapper.className = 'array-input-wrapper';
            wrapper.dataset.arrayId = arrayId;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'array-input';
            input.dataset.arrayId = arrayId;
            input.placeholder = `è¾“å…¥æ•°ç»„${arrayId}ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ï¼š${arrayId},${arrayId*2},${arrayId*3}`;
            input.value = '';
            
            wrapper.appendChild(input);
            arrayInputsContainer.insertBefore(wrapper, renderArrayBtn);
        }

        // åˆ›å»ºæ•°ç»„å®¹å™¨
        function createArrayContainer(arrayId) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (document.querySelector(`.array-container[data-array-id="${arrayId}"]`)) {
                return;
            }
            
            const container = document.createElement('div');
            container.className = 'array-container';
            container.dataset.arrayId = arrayId;
            
            const label = document.createElement('div');
            label.className = 'array-label';
            label.textContent = getArrayName(arrayId);
            label.addEventListener('dblclick', () => startEditArrayName(arrayId, label));
            
            container.appendChild(label);
            arraysContainer.appendChild(container);
        }

        // åˆ é™¤æœ€åä¸€ä¸ªæ•°ç»„
        function removeLastArray() {
            if (maxArrayId <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªæ•°ç»„ï¼');
                return;
            }
            
            // åˆ é™¤æ•°ç»„æ•°æ®
            delete currentArrays[maxArrayId];
            
            // åˆ é™¤è¾“å…¥æ¡†
            const inputWrapper = document.querySelector(`.array-input-wrapper[data-array-id="${maxArrayId}"]`);
            if (inputWrapper) inputWrapper.remove();
            
            // åˆ é™¤å®¹å™¨
            const arrayContainer = document.querySelector(`.array-container[data-array-id="${maxArrayId}"]`);
            if (arrayContainer) arrayContainer.remove();
            
            // æ›´æ–°æœ€å¤§ID
            maxArrayId--;
            
            // å¦‚æœå½“å‰æ¨¡å¼æ˜¯doubleä¸”åˆ é™¤çš„æ˜¯æ•°ç»„2ï¼Œåˆ‡æ¢åˆ°single
            if (currentMode === 'double' && maxArrayId === 1) {
                switchMode('single');
            }
            
            renderArray();
        }
        function removeArrayById(arrayId) {
            const keys = Object.keys(currentArrays).map(k => Number(k));
            if (keys.length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªæ•°ç»„ï¼');
                return;
            }
            if (!currentArrays[arrayId]) {
                return;
            }
            delete currentArrays[arrayId];
            const inputWrapper = document.querySelector(`.array-input-wrapper[data-array-id="${arrayId}"]`);
            if (inputWrapper) inputWrapper.remove();
            const arrayContainer = document.querySelector(`.array-container[data-array-id="${arrayId}"]`);
            if (arrayContainer) arrayContainer.remove();
            const leftKeys = Object.keys(currentArrays).map(k => Number(k));
            if (!leftKeys.includes(activeArrayId)) {
                activeArrayId = leftKeys.length ? leftKeys[0] : 1;
            }
            if (currentMode === 'double' && leftKeys.length === 1) {
                switchMode('single');
            }
            renderArray();
        }

        // æ¸²æŸ“æ•°ç»„
        function renderArray() {
            clearPointers();
            // è§£ææ‰€æœ‰æ¿€æ´»çš„æ•°ç»„è¾“å…¥
            document.querySelectorAll('.array-input-wrapper.active').forEach(wrapper => {
                const arrayId = Number(wrapper.dataset.arrayId);
                const input = wrapper.querySelector('.array-input');
                const arrayValue = input.value.trim();
                // æ”¯æŒå­—ç¬¦ä¸æ•°å­—ï¼Œç»Ÿä¸€æŒ‰å­—ç¬¦ä¸²å¤„ç†
                currentArrays[arrayId] = arrayValue ? arrayValue.split(',').map(item => item.trim()) : [];
            });

            // æ¸…ç©ºæ‰€æœ‰æ•°ç»„å®¹å™¨
            document.querySelectorAll('.array-container').forEach(container => {
                const label = container.querySelector('.array-label');
                container.innerHTML = '';
                if (label) {
                    const aid = Number(container.dataset.arrayId);
                    label.textContent = getArrayName(aid);
                    label.addEventListener('dblclick', () => startEditArrayName(aid, label));
                    container.appendChild(label);
                }
            });

            // æ¸²æŸ“æ‰€æœ‰æ¿€æ´»çš„æ•°ç»„
            document.querySelectorAll('.array-container.active').forEach(container => {
                const arrayId = Number(container.dataset.arrayId);
                if (currentArrays[arrayId]) {
                    renderSingleArray(arrayId, currentArrays[arrayId], container);
                    if (arrayId === activeArrayId) {
                        container.classList.add('selected');
                    } else {
                        container.classList.remove('selected');
                    }
                }
            });

            // é‡æ–°å®šä½æ‰€æœ‰æŒ‡é’ˆ
            repositionPointers();
            // æ›´æ–°é«˜äº®
            updateArrayItemHighlight();
            // é«˜äº®ç›®æ ‡å€¼
            updateTargetHighlight();
            // å…³ç³»é«˜äº®
            updateRelationHighlight();
            // æ›´æ–°ç»Ÿè®¡
            updateTargetStats();
        }

        function getArrayName(arrayId) {
            return arrayNames[arrayId] || `æ•°æ®${arrayId}`;
        }
        function setArrayName(arrayId, name) {
            arrayNames[arrayId] = name && name.trim() ? name.trim() : `æ•°æ®${arrayId}`;
        }
        function startEditArrayName(arrayId, labelEl) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = getArrayName(arrayId);
            input.style.fontSize = '0.85rem';
            input.style.padding = '2px 8px';
            input.style.border = '1px solid #c7d2fe';
            input.style.borderRadius = '999px';
            input.style.boxSizing = 'border-box';
            input.style.display = 'inline-block';
            input.style.width = '50%';
            input.style.maxWidth = '160px';
            const commit = () => { setArrayName(arrayId, input.value); labelEl.textContent = getArrayName(arrayId); input.remove(); };
            input.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') { commit(); } });
            input.addEventListener('blur', commit);
            labelEl.textContent = '';
            labelEl.appendChild(input);
            input.focus();
        }
        function setFocusedItem(arrayId, index, el) {
            if (pointers.length) { applyPointerFocus(); return; }
            document.querySelectorAll('.array-item.focused').forEach(x => x.classList.remove('focused'));
            focusedItem = { arrayId, index };
            el.classList.add('focused');
        }
        function focusEditFocusedItem() {
            let aid = focusedItem?.arrayId;
            let idx = focusedItem?.index;
            if (pointers.length) {
                if (!selectedPointer) { selectedPointer = pointers[0]; }
                aid = selectedPointer.arrayId; idx = selectedPointer.index;
            }
            if (aid === undefined || idx === undefined) return;
            const item = document.querySelector(`.array-container[data-array-id="${aid}"] .array-item[data-index="${idx}"]`);
            const inp = item?.querySelector('.array-value');
            const txt = item?.querySelector('.array-value-text');
            if (item && inp && txt) { item.classList.add('editing'); inp.value = String(txt.textContent || ''); inp.focus(); inp.select(); }
        }
        function applyPointerFocus() {
            if (!selectedPointer && pointers.length) { selectedPointer = pointers[0]; }
            document.querySelectorAll('.array-item.focused').forEach(x => x.classList.remove('focused'));
            if (selectedPointer) {
                const el = document.querySelector(`.array-container[data-array-id="${selectedPointer.arrayId}"] .array-item[data-index="${selectedPointer.index}"]`);
                if (el) {
                    focusedItem = { arrayId: selectedPointer.arrayId, index: selectedPointer.index };
                    el.classList.add('focused');
                }
            }
        }
        function addPointerOnItem(arrayId, index) {
            updateDefaultPointerName();
            const name = pointerNameInput.value.trim() || 'i';
            // è‹¥é‡åï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ª
            if (pointers.some(p => p.name === name)) {
                updateDefaultPointerName();
            }
            const nm = pointerNameInput.value.trim() || name;
            addPointerWith(nm, arrayId, index, 'bottom');
        }
        function addMemberAtFront() {
            const arrayId = focusedItem?.arrayId || 1;
            if (!currentArrays[arrayId]) currentArrays[arrayId] = [];
            currentArrays[arrayId].unshift('0');
            const input = document.querySelector(`.array-input[data-array-id="${arrayId}"]`);
            if (input) input.value = currentArrays[arrayId].join(',');
            // æŒ‡é’ˆå¤„ç†ï¼šè‹¥å­˜åœ¨ï¼Œä»¤ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ–°å…ƒç´ 
            if (pointers.length) {
                const p = selectedPointer || pointers[0];
                p.arrayId = arrayId; p.index = 0; setPointerPosition(p); selectPointer(p);
            }
            renderArray();
            // èšç„¦æ–°ç¬¬ä¸€ä¸ª
            const item = document.querySelector(`.array-container[data-array-id="${arrayId}"] .array-item[data-index="0"]`);
            if (item) setFocusedItem(arrayId, 0, item);
        }
        function addMemberAtEnd() {
            const arrayId = focusedItem?.arrayId || 1;
            if (!currentArrays[arrayId]) currentArrays[arrayId] = [];
            currentArrays[arrayId].push('0');
            const input = document.querySelector(`.array-input[data-array-id="${arrayId}"]`);
            if (input) input.value = currentArrays[arrayId].join(',');
            renderArray();
            const lastIdx = Math.max(0, currentArrays[arrayId].length - 1);
            const item = document.querySelector(`.array-container[data-array-id="${arrayId}"] .array-item[data-index="${lastIdx}"]`);
            if (item) setFocusedItem(arrayId, lastIdx, item);
            if (pointers.length) {
                const p = selectedPointer || pointers[0];
                p.arrayId = arrayId; p.index = lastIdx; setPointerPosition(p); selectPointer(p);
            }
        }
        function deleteFocusedMember() {
            if (!focusedItem) return;
            const { arrayId, index } = focusedItem;
            const arr = currentArrays[arrayId]; if (!arr || !arr.length) return;
            arr.splice(index, 1);
            
            // æŒ‡é’ˆï¼šåˆ é™¤æŒ‡å‘è¯¥å…ƒç´ çš„æŒ‡é’ˆï¼Œå¹¶è°ƒæ•´åç»­ç´¢å¼•
            const toRemove = new Set();
            pointers.forEach(p => { if (p.arrayId === arrayId) { if (p.index === index) toRemove.add(p.id); else if (p.index > index) p.index--; }});
            pointers = pointers.filter(p => { if (toRemove.has(p.id)) { p.element.remove(); return false; } return true; });
            const input = document.querySelector(`.array-input[data-array-id="${arrayId}"]`);
            if (input) input.value = arr.join(',');
            renderArray();
            const newIdx = Math.min(index, Math.max(0, (currentArrays[arrayId]?.length || 1) - 1));
            const item = document.querySelector(`.array-container[data-array-id="${arrayId}"] .array-item[data-index="${newIdx}"]`);
            if (item) setFocusedItem(arrayId, newIdx, item);
            repositionPointers();
        }

        function toggleControlsArea() {
            const panel = document.getElementById('array-config');
            const collapsed = panel.classList.toggle('collapsed');
            const btn = document.getElementById('toggle-controls');
            btn.innerHTML = `${collapsed ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg> å±•å¼€' : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg> æŠ˜å '}`;
        }

        // æ¸²æŸ“å•ä¸ªæ•°ç»„
        function renderSingleArray(arrayId, arrayData, container) {
            arrayData.forEach((value, index) => {
                const arrayItem = document.createElement('div');
                arrayItem.className = 'array-item';
                arrayItem.dataset.array = arrayId;
                arrayItem.dataset.index = index;

                const indexLabel = document.createElement('div');
                indexLabel.className = 'array-index';
                indexLabel.textContent = `[${index}]`;

                // æ•°å€¼/å­—ç¬¦å±•ç¤ºï¼ˆæ–‡æœ¬ï¼‰
                const valueText = document.createElement('div');
                valueText.className = 'array-value-text';
                valueText.textContent = String(value);
                // å¯ç¼–è¾‘è¾“å…¥ï¼ˆé»˜è®¤éšè—ï¼‰
                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.className = 'array-value';
                valueInput.value = String(value);
                valueInput.style.textAlign = 'center';
                valueInput.style.border = '1px solid #ddd';
                valueInput.style.borderRadius = '6px';
                valueInput.style.padding = '2px 6px';
                valueInput.style.minWidth = '50px';
                valueInput.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter') { valueInput.blur(); }
                });
                valueInput.addEventListener('blur', () => {
                    const fakeEvent = { target: valueInput };
                    updateArrayValue(fakeEvent);
                    valueText.textContent = String(valueInput.value);
                    const itemEl = valueInput.closest('.array-item');
                    if (itemEl) { itemEl.classList.remove('editing'); }
                });

                // ç»„è£…
                arrayItem.appendChild(valueText);
                arrayItem.appendChild(valueInput);
                arrayItem.appendChild(indexLabel);
                container.appendChild(arrayItem);

                // æ‚¬åœèšç„¦
                arrayItem.addEventListener('mouseenter', () => setFocusedItem(arrayId, index, arrayItem));
                // åŒå‡»æ·»åŠ æŒ‡é’ˆ
                arrayItem.addEventListener('dblclick', () => addPointerOnItem(arrayId, index));
            });
        }

        // åŠ¨æ€æ·»åŠ æ•°ç»„å…ƒç´ 
        function addArrayItem() {
            // ç¡®å®šç›®æ ‡æ•°ç»„
            let targetArrayId = activeArrayId || 1;
            
            // æ·»åŠ å…ƒç´ 
            if (!currentArrays[targetArrayId]) {
                currentArrays[targetArrayId] = [];
            }
            currentArrays[targetArrayId].push('0');
            
            // æ›´æ–°è¾“å…¥æ¡†
            const input = document.querySelector(`.array-input[data-array-id="${targetArrayId}"]`);
            if (input) {
                input.value = currentArrays[targetArrayId].join(',');
            }
            
            renderArray();
        }

        // åŠ¨æ€åˆ é™¤æ•°ç»„å…ƒç´ 
        function removeArrayItem() {
            // ç¡®å®šç›®æ ‡æ•°ç»„
            let targetArrayId = activeArrayId || 1;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å…ƒç´ å¯åˆ 
            if (!currentArrays[targetArrayId] || currentArrays[targetArrayId].length <= 0) {
                alert(`æ•°ç»„${targetArrayId}å·²æ— å…ƒç´ å¯åˆ ï¼`);
                return;
            }
            
            // åˆ é™¤å…ƒç´ 
            currentArrays[targetArrayId].pop();
            
            // æ›´æ–°è¾“å…¥æ¡†
            const input = document.querySelector(`.array-input[data-array-id="${targetArrayId}"]`);
            if (input) {
                input.value = currentArrays[targetArrayId].join(',');
            }
            
            renderArray();
        }

        // æ·»åŠ æŒ‡é’ˆ
        function addPointer() {
            const pointerName = pointerNameInput.value.trim();
            if (!pointerName) {
                alert('è¯·è¾“å…¥æŒ‡é’ˆåç§°ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæŒ‡é’ˆ
            const exists = pointers.some(p => p.name === pointerName);
            if (exists) {
                alert(`æŒ‡é’ˆ "${pointerName}" å·²å­˜åœ¨ï¼`);
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°ç»„
            if (Object.keys(currentArrays).length === 0 || currentArrays[1].length === 0) {
                alert('è¯·å…ˆæ¸²æŸ“æ•°ç»„ï¼');
                return;
            }

            // è·å–æŒ‡é’ˆé¢œè‰²
            const pointerColor = pointerColors[colorIndex % pointerColors.length];
            colorIndex++;

            // åˆ›å»ºæŒ‡é’ˆå…ƒç´ ï¼ˆä»…å°åœ†ç‚¹+å†…éƒ¨å­—ç¬¦ï¼‰
            const pointerId = `pointer-${Date.now()}`;
            const pointer = document.createElement('div');
            pointer.id = pointerId;
            pointer.className = 'pointer position-bottom';
            pointer.textContent = pointerName; // ä»…å†…éƒ¨å­—ç¬¦
            pointer.dataset.name = pointerName;
            pointer.style.background = pointerColor;
            pointer.style.setProperty('--pointer-color', pointerColor.replace('0.8', '1'));

            // æ·»åŠ åˆ°å¯è§†åŒ–åŒºåŸŸ
            visualization.appendChild(pointer);

            // å­˜å‚¨æŒ‡é’ˆä¿¡æ¯
            const pointerInfo = {
                id: pointerId,
                name: pointerName,
                element: pointer,
                arrayId: 1,
                index: 0,
                color: pointerColor.replace('0.8', '1'),
                positionType: 'bottom'
            };
            pointers.push(pointerInfo);

            // è®¾ç½®åˆå§‹ä½ç½®
            setPointerPosition(pointerInfo);

            // ç»‘å®šæŒ‡é’ˆç‚¹å‡»äº‹ä»¶
            pointer.addEventListener('click', (e) => {
                e.stopPropagation();
                selectPointer(pointerInfo);
            });
            // åŒå‡»åˆ é™¤æŒ‡é’ˆ
            pointer.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                selectPointer(pointerInfo);
                removeSelectedPointer();
            });

            // é»˜è®¤é€‰ä¸­æ–°æ·»åŠ çš„æŒ‡é’ˆ
            selectPointer(pointerInfo);
            
            // æ›´æ–°é»˜è®¤æŒ‡é’ˆåç§°
            updateDefaultPointerName();
        }

        // é€‰æ‹©æŒ‡é’ˆ
        function selectPointer(pointerInfo) {
            // å–æ¶ˆä¹‹å‰é€‰ä¸­çš„æŒ‡é’ˆæ ·å¼
            pointers.forEach(p => {
                p.element.classList.remove('selected');
            });

            // è®¾ç½®å½“å‰é€‰ä¸­æŒ‡é’ˆæ ·å¼
            pointerInfo.element.classList.add('selected');
            selectedPointer = pointerInfo;

            // æ›´æ–°é«˜äº®
            updateArrayItemHighlight();
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updatePointerStatus();
            applyPointerFocus();
        }

        // åˆ é™¤é€‰ä¸­æŒ‡é’ˆ
        function removeSelectedPointer() {
            if (!selectedPointer) {
                alert('è¯·å…ˆé€‰ä¸­è¦åˆ é™¤çš„æŒ‡é’ˆï¼');
                return;
            }

            // ä»DOMç§»é™¤
            selectedPointer.element.remove();

            // ä»æ•°ç»„ç§»é™¤
            pointers = pointers.filter(p => p.id !== selectedPointer.id);

            // é‡ç½®é€‰ä¸­çŠ¶æ€
            selectedPointer = null;
            
            // ç§»é™¤é«˜äº®
            updateArrayItemHighlight();

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updatePointerStatus();
            
            // æ›´æ–°é»˜è®¤æŒ‡é’ˆåç§°
            updateDefaultPointerName();
        }

        // ç§»åŠ¨æŒ‡é’ˆ
        function movePointer(pointerInfo, direction) {
            let newArrayId = pointerInfo.arrayId;
            let newIndex = pointerInfo.index;
            let newPositionType = pointerInfo.positionType;

            switch(direction) {
                case 'left':
                    newIndex = Math.max(0, pointerInfo.index - 1);
                    break;
                case 'right':
                    newIndex = Math.min(currentArrays[pointerInfo.arrayId].length - 1, pointerInfo.index + 1);
                    break;
                case 'up':
                    // å…ˆåˆ‡æ¢å½“å‰æ•°ç»„å†…ä½ç½®ï¼ˆä¸‹â†’ä¸Šï¼‰
                    if (pointerInfo.positionType === 'bottom') {
                        newPositionType = 'top';
                    } else {
                        // å¤šæ•°ç»„æ¨¡å¼ä¸‹åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªæ•°ç»„
                        if (currentMode === 'multi' && pointerInfo.arrayId > 1) {
                            newArrayId = pointerInfo.arrayId - 1;
                            newIndex = Math.min(currentArrays[newArrayId]?.length - 1 || 0, pointerInfo.index);
                        } else if (currentMode === 'double' && pointerInfo.arrayId === 2) {
                            newArrayId = 1;
                            newIndex = Math.min(currentArrays[1].length - 1, pointerInfo.index);
                        }
                    }
                    break;
                case 'down':
                    // å…ˆåˆ‡æ¢å½“å‰æ•°ç»„å†…ä½ç½®ï¼ˆä¸Šâ†’ä¸‹ï¼‰
                    if (pointerInfo.positionType === 'top') {
                        newPositionType = 'bottom';
                    } else {
                        // å¤šæ•°ç»„æ¨¡å¼ä¸‹åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ•°ç»„
                        if (currentMode === 'multi' && pointerInfo.arrayId < maxArrayId) {
                            newArrayId = pointerInfo.arrayId + 1;
                            newIndex = Math.min(currentArrays[newArrayId]?.length - 1 || 0, pointerInfo.index);
                        } else if (currentMode === 'double' && pointerInfo.arrayId === 1) {
                            newArrayId = 2;
                            newIndex = Math.min(currentArrays[2].length - 1, pointerInfo.index);
                        }
                    }
                    break;
            }

            // éªŒè¯æ•°ç»„æ˜¯å¦å­˜åœ¨
            if (!currentArrays[newArrayId]) {
                return;
            }

            // ç¡®ä¿ç´¢å¼•æœ‰æ•ˆ
            newIndex = Math.max(0, Math.min(currentArrays[newArrayId].length - 1, newIndex));

            // æ›´æ–°æŒ‡é’ˆå±æ€§
            pointerInfo.arrayId = newArrayId;
            pointerInfo.index = newIndex;
            pointerInfo.positionType = newPositionType;

            // æ›´æ–°æŒ‡é’ˆæ ·å¼ç±»
            pointerInfo.element.classList.remove('position-top', 'position-bottom');
            pointerInfo.element.classList.add(`position-${newPositionType}`);

            // é‡æ–°å®šä½æŒ‡é’ˆ
            setPointerPosition(pointerInfo);

            // æ›´æ–°é«˜äº®å’ŒçŠ¶æ€
            updateArrayItemHighlight();
            updatePointerStatus();
            if (isRecording) {
                recordLog.push({ t: Date.now(), type: 'move', name: pointerInfo.name, arrayId: pointerInfo.arrayId, index: pointerInfo.index, pos: pointerInfo.positionType });
                updateRecordStatus();
            }
        }

        // è®¾ç½®æŒ‡é’ˆä½ç½®ï¼ˆé€‚é…é¡µé¢å®½åº¦å˜åŒ–ï¼‰
        function setPointerPosition(pointerInfo) {
            // è·å–ç›®æ ‡æ•°ç»„å…ƒç´ 
            const targetContainer = document.querySelector(`.array-container[data-array-id="${pointerInfo.arrayId}"]`);
            const targetItem = targetContainer?.querySelector(`.array-item[data-index="${pointerInfo.index}"]`);
            
            if (targetItem) {
                const itemRect = targetItem.getBoundingClientRect();
                const visRect = visualization.getBoundingClientRect();
                const rawTop = itemRect.top - visRect.top;
                const rawLeft = itemRect.left - visRect.left;
                const baseTop = rawTop / (zoomScale || 1);
                const baseLeft = rawLeft / (zoomScale || 1);
                pointerInfo.element.style.setProperty('--item-top', `${baseTop}px`);
                pointerInfo.element.style.setProperty('--item-left', `${baseLeft}px`);
            }
        }

        // é‡æ–°å®šä½æ‰€æœ‰æŒ‡é’ˆ
        function repositionPointers() {
            pointers.forEach(pointer => {
                setPointerPosition(pointer);
            });
        }

        // é«˜äº®å½“å‰æŒ‡é’ˆæŒ‡å‘çš„æ•°ç»„å…ƒç´ 
        function updateArrayItemHighlight() {
            // ç§»é™¤æ‰€æœ‰é«˜äº®
            document.querySelectorAll('.array-item').forEach(item => {
                item.classList.remove('highlighted');
            });

            // é«˜äº®é€‰ä¸­æŒ‡é’ˆæŒ‡å‘çš„å…ƒç´ 
            if (selectedPointer) {
                const targetContainer = document.querySelector(`.array-container[data-array-id="${selectedPointer.arrayId}"]`);
                const targetItem = targetContainer?.querySelector(`.array-item[data-index="${selectedPointer.index}"]`);
                if (targetItem) {
                    targetItem.classList.add('highlighted');
                }
            }
            if (pointers.length) { applyPointerFocus(); }
        }

        // æ›´æ–°æ•°ç»„å€¼
        function updateArrayValue(e) {
            const arrayId = Number(e.target.closest('.array-item').dataset.array);
            const index = Number(e.target.closest('.array-item').dataset.index);
            const raw = e.target.value;
            const newValue = raw;
            if (currentArrays[arrayId]) {
                currentArrays[arrayId][index] = newValue;
                // æ›´æ–°è¾“å…¥æ¡†
                const input = document.querySelector(`.array-input[data-array-id="${arrayId}"]`);
                if (input) {
                    input.value = currentArrays[arrayId].join(',');
                }
                // åŒæ­¥æ˜¾ç¤ºæ–‡æœ¬
                const item = document.querySelector(`.array-container[data-array-id="${arrayId}"] .array-item[data-index="${index}"]`);
                const txt = item?.querySelector('.array-value-text');
                if (txt) txt.textContent = String(newValue);
            }
            if (isRecording) {
                recordLog.push({ t: Date.now(), type: 'update', arrayId, index, value: newValue });
                updateRecordStatus();
            }
            updateTargetHighlight();
            updateRelationHighlight();
            updateTargetStats();
        }

        // æ›´æ–°æŒ‡é’ˆçŠ¶æ€æ˜¾ç¤º
        function updatePointerStatus() {
            if (!selectedPointer) {
                pointerStatus.textContent = 'å½“å‰é€‰ä¸­ï¼šæ—  | ä½ç½®ï¼š-';
                return;
            }
            
            const posText = `æ•°ç»„${selectedPointer.arrayId}[${selectedPointer.index}] ${selectedPointer.positionType === 'top' ? 'ä¸Šæ–¹' : 'ä¸‹æ–¹'} = ${currentArrays[selectedPointer.arrayId]?.[selectedPointer.index] || 'undefined'}`;
            pointerStatus.textContent = `å½“å‰é€‰ä¸­ï¼š${selectedPointer.name} | ä½ç½®ï¼š${posText}`;
        }
        function clearPointers() {
            pointers.forEach(p => p.element.remove());
            pointers = [];
            selectedPointer = null;
            updatePointerStatus();
            updateArrayItemHighlight();
            updateDefaultPointerName();
        }

        // è®°å½•æ­¥éª¤
        function recordStep() {
            // æ„å»ºæ­¥éª¤æè¿°
            let stepDesc = '';
            
            // æ·»åŠ æ‰€æœ‰æ•°ç»„ä¿¡æ¯
            const activeArrays = Object.keys(currentArrays).map(id => Number(id)).filter(id => 
                document.querySelector(`.array-container[data-array-id="${id}"].active`)
            );
            
            stepDesc += activeArrays.map(id => 
                `æ•°ç»„${id}: [${currentArrays[id].join(', ')}]`
            ).join(' | ') + ' | ';
            
            // æ·»åŠ æŒ‡é’ˆçŠ¶æ€
            const pointerStatus = pointers.map(p => 
                `${p.name} â†’ æ•°ç»„${p.arrayId}[${p.index}] ${p.positionType === 'top' ? 'ä¸Šæ–¹' : 'ä¸‹æ–¹'} = ${currentArrays[p.arrayId]?.[p.index] || 'undefined'}`
            ).join(' | ');
            
            stepDesc += `æŒ‡é’ˆçŠ¶æ€: ${pointerStatus || 'æ— æŒ‡é’ˆ'}`;
            
            // åˆ›å»ºæ­¥éª¤é¡¹
            const stepItem = document.createElement('li');
            stepItem.className = 'step-item';
            
            const stepText = document.createElement('span');
            stepText.textContent = stepDesc;
            
            const stepTime = document.createElement('span');
            stepTime.className = 'step-time';
            stepTime.textContent = new Date().toLocaleTimeString();
            
            stepItem.appendChild(stepText);
            stepItem.appendChild(stepTime);
            
            // æ·»åŠ åˆ°åˆ—è¡¨å¼€å¤´
            stepList.insertBefore(stepItem, stepList.firstChild);
        }

        // ç”Ÿæˆæ•°ç»„å¿«ç…§
        function takeSnapshot() {
            // æ„å»ºå¿«ç…§å†…å®¹
            let snapshot = `=== ç®—æ³•æ¨æ¼”å¿«ç…§ [${new Date().toLocaleString()}] ===\n`;
            snapshot += `æ¨¡å¼: ${currentMode === 'single' ? 'å•æ•°ç»„' : currentMode === 'double' ? 'åŒæ•°ç»„' : 'å¤šæ•°ç»„'}\n`;
            snapshot += `æ•°ç»„æ•°é‡: ${Object.keys(currentArrays).length}\n\n`;
            
            // æ·»åŠ æ‰€æœ‰æ•°ç»„ä¿¡æ¯
            Object.keys(currentArrays).sort((a, b) => a - b).forEach(id => {
                const arrayId = Number(id);
                snapshot += `æ•°ç»„${arrayId}: [${currentArrays[arrayId].join(', ')}] (é•¿åº¦: ${currentArrays[arrayId].length})\n`;
            });
            
            snapshot += `\næŒ‡é’ˆä¿¡æ¯:\n`;
            
            if (pointers.length === 0) {
                snapshot += '  æ— æŒ‡é’ˆ\n';
            } else {
                pointers.forEach(p => {
                    snapshot += `  ${p.name} (é¢œè‰²: ${p.color}): æ•°ç»„${p.arrayId}[${p.index}] ${p.positionType === 'top' ? 'ä¸Šæ–¹' : 'ä¸‹æ–¹'} = ${currentArrays[p.arrayId]?.[p.index] || 'undefined'}\n`;
                });
            }

            // æ˜¾ç¤ºå¿«ç…§
            snapshotContainer.textContent = snapshot;
            snapshotContainer.style.display = 'block';
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            // é‡ç½®æ•°ç»„
            currentArrays = { 1: [] };
            maxArrayId = 1;
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.querySelectorAll('.array-input').forEach(input => {
                input.value = '';
            });
            
            // é‡ç½®æ•°ç»„å®¹å™¨
            document.querySelectorAll('.array-container').forEach(container => {
                const label = container.querySelector('.array-label');
                container.innerHTML = '';
                container.appendChild(label);
            });
            
            // åˆ é™¤å¤šä½™çš„æ•°ç»„è¾“å…¥å’Œå®¹å™¨ï¼ˆä¿ç•™æ•°ç»„1ï¼‰
            document.querySelectorAll('.array-input-wrapper[data-array-id]:not([data-array-id="1"])').forEach(wrapper => {
                wrapper.remove();
            });
            document.querySelectorAll('.array-container[data-array-id]:not([data-array-id="1"])').forEach(container => {
                container.remove();
            });
            
            // ç§»é™¤æ‰€æœ‰æŒ‡é’ˆ
            pointers.forEach(p => p.element.remove());
            pointers = [];
            selectedPointer = null;
            colorIndex = 0;
            
            // æ¸…ç©ºæ­¥éª¤
            stepList.innerHTML = '';
            
            // éšè—å¿«ç…§
            snapshotContainer.style.display = 'none';
            
            // åˆ‡æ¢åˆ°å•æ•°ç»„æ¨¡å¼
            switchMode('single');

            // æ›´æ–°çŠ¶æ€å’Œé»˜è®¤æŒ‡é’ˆåç§°
            updatePointerStatus();
            updateDefaultPointerName();

            // é‡ç½®ç›®æ ‡å€¼
            targetValue = null;
            if (targetInput) targetInput.value = '';
            if (targetStatus) targetStatus.textContent = 'ç›®æ ‡ï¼šæœªè®¾ç½®';
            updateTargetHighlight();
            clearAllRelationHighlights();
            relationModeSelect.value = 'none';
            relationMode = 'none';
            updateTargetStats();
        }

        // ä»è¾“å…¥æ›´æ–°ç›®æ ‡å€¼
        function updateTargetFromInput() {
            const v = Number(targetInput.value);
            if (Number.isFinite(v)) {
                targetValue = v;
                targetStatus.textContent = `ç›®æ ‡ï¼š${targetValue}`;
            } else {
                targetValue = null;
                targetStatus.textContent = 'ç›®æ ‡ï¼šæœªè®¾ç½®';
            }
            updateTargetHighlight();
            updateRelationHighlight();
            updateTargetStats();
        }

        // æ ¹æ®ç›®æ ‡å€¼æ›´æ–°æ•°ç»„å…ƒç´ é«˜äº®
        function updateTargetHighlight() {
            if (!enableTargetHighlight) {
                document.querySelectorAll('.array-item').forEach(item => item.classList.remove('target-match'));
                return;
            }
            const items = document.querySelectorAll('.array-item');
            items.forEach(item => {
                const inputEl = item.querySelector('.array-value');
                const raw = inputEl ? inputEl.value : '';
                const val = Number(raw);
                if (targetValue !== null && Number.isFinite(val) && val === targetValue) {
                    item.classList.add('target-match');
                } else {
                    item.classList.remove('target-match');
                }
            });
        }

        // æ¸…é™¤å…³ç³»é«˜äº®
        function clearAllRelationHighlights() {
            document.querySelectorAll('.array-item').forEach(item => {
                item.classList.remove('two-sum-match', 'three-sum-match');
            });
        }

        // æ›´æ–°å…³ç³»é«˜äº®ï¼ˆä¸¤æ•°/ä¸‰æ•°ä¹‹å’Œï¼‰
        function updateRelationHighlight() {
            clearAllRelationHighlights();
            if (!enableRelationHighlight) return;
            if (!targetValue || !Number.isFinite(targetValue) || relationMode === 'none') return;

            // æ”¶é›†æ¿€æ´»æ•°ç»„çš„æ‰€æœ‰å…ƒç´ 
            const entries = [];
            document.querySelectorAll('.array-container.active').forEach(container => {
                const aid = Number(container.dataset.arrayId);
                container.querySelectorAll('.array-item').forEach(item => {
                    const idx = Number(item.dataset.index);
                    const txt = item.querySelector('.array-value')?.value;
                    const val = Number(txt);
                    if (Number.isFinite(val)) entries.push({ aid, idx, val, el: item });
                });
            });

            if (relationMode === 'two-sum') {
                const seen = new Map(); // val -> list of entries
                entries.forEach(e => {
                    if (!seen.has(e.val)) seen.set(e.val, []);
                    seen.get(e.val).push(e);
                });
                entries.forEach(e => {
                    const need = targetValue - e.val;
                    const list = seen.get(need);
                    if (list) {
                        list.forEach(f => {
                            // é¿å…åŒå…ƒç´ é‡å¤ï¼ˆå…è®¸è·¨æ•°ç»„æˆ–åŒæ•°ç»„ä¸åŒç´¢å¼•ï¼‰
                            if (e.el !== f.el) {
                                e.el.classList.add('two-sum-match');
                                f.el.classList.add('two-sum-match');
                            }
                        });
                    }
                });
            } else if (relationMode === 'three-sum') {
                // æœ´ç´ ä¸‰æ•°ä¹‹å’Œï¼ˆé€‚ç”¨äºä¸­å°è§„æ¨¡ï¼‰
                const n = entries.length;
                for (let i = 0; i < n; i++) {
                    for (let j = i + 1; j < n; j++) {
                        for (let k = j + 1; k < n; k++) {
                            const sum = entries[i].val + entries[j].val + entries[k].val;
                            if (sum === targetValue) {
                                entries[i].el.classList.add('three-sum-match');
                                entries[j].el.classList.add('three-sum-match');
                                entries[k].el.classList.add('three-sum-match');
                            }
                        }
                    }
                }
            }
        }

        // æ›´æ–°ç›®æ ‡ç»Ÿè®¡ä¸æŒ‡é’ˆè·ç¦»
        function updateTargetStats() {
            if (!targetStatus) return;
            if (targetValue === null || !Number.isFinite(targetValue)) {
                targetStatus.textContent = 'ç›®æ ‡ï¼šæœªè®¾ç½®';
                return;
            }

            // ç»Ÿè®¡æ¯ä¸ªæ¿€æ´»æ•°ç»„çš„ç›®æ ‡å‡ºç°
            const stats = [];
            document.querySelectorAll('.array-container.active').forEach(container => {
                const aid = Number(container.dataset.arrayId);
                const idxs = [];
                container.querySelectorAll('.array-item').forEach(item => {
                    const idx = Number(item.dataset.index);
                    const txt = item.querySelector('.array-value-text')?.textContent;
                    const val = Number(txt);
                    if (Number.isFinite(val) && val === targetValue) idxs.push(idx);
                });
                stats.push({ aid, idxs });
            });

            // è®¡ç®—å„æŒ‡é’ˆåˆ°ç›®æ ‡çš„æœ€è¿‘/æœ€è¿œè·ç¦»ï¼ˆåŒæ•°ç»„ï¼‰
            const pointerDistances = pointers.map(p => {
                const s = stats.find(x => x.aid === p.arrayId);
                if (!s || s.idxs.length === 0) return `${p.name}â†’æ— `; 
                const dists = s.idxs.map(ix => Math.abs(ix - p.index));
                const min = Math.min(...dists);
                const max = Math.max(...dists);
                return `${p.name}â†’æœ€è¿‘${min} æœ€è¿œ${max}`;
            });

            const distText = pointerDistances.length ? ` | ${pointerDistances.join(' ; ')}` : '';
            const statText = stats.map(s => `æ•°ç»„${s.aid}Ã—${s.idxs.length}${s.idxs.length ? '[' + s.idxs.join(',') + ']' : ''}`).join(' | ');
            targetStatus.textContent = `ç›®æ ‡ï¼š${targetValue} | åˆ†å¸ƒï¼š${statText}${distText}`;
        }

        function applyZoom() {
            if (visualization) {
                visualization.style.transform = `scale(${zoomScale})`;
                visualization.style.transformOrigin = 'center top';
                repositionPointers();
            }
        }

        function applyLogEntry(e) {
            if (!e) return;
            if (e.type === 'move') {
                const p = pointers.find(pp => pp.name === e.name);
                if (p) {
                    p.arrayId = e.arrayId;
                    p.index = e.index;
                    p.positionType = e.pos;
                    p.element.classList.remove('position-top', 'position-bottom');
                    p.element.classList.add(`position-${p.positionType}`);
                    setPointerPosition(p);
                    selectPointer(p);
                }
            } else if (e.type === 'update') {
                const container = document.querySelector(`.array-container[data-array-id="${e.arrayId}"]`);
                const item = container?.querySelector(`.array-item[data-index="${e.index}"]`);
                const input = item?.querySelector('.array-value');
                if (input) {
                    input.value = e.value;
                    currentArrays[e.arrayId][e.index] = e.value;
                }
            }
            updateArrayItemHighlight();
            updateTargetHighlight();
            updateRelationHighlight();
            updateTargetStats();
        }

        function stopPlayback() {
            if (playbackTimer) {
                clearTimeout(playbackTimer);
                playbackTimer = null;
            }
        }

        function stepPlayback(direction) {
            if (!recordLog.length) return;
            stopPlayback();
            playbackIndex = Math.max(0, Math.min(recordLog.length - 1, playbackIndex + direction));
            applyLogEntry(recordLog[playbackIndex]);
        }

        function handleImportRecording(e) {
            const file = e.target.files?.[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const payload = JSON.parse(reader.result);
                    applyImportedRecording(payload);
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯');
                } finally {
                    importRecordFile.value = '';
                }
            };
            reader.readAsText(file);
        }

        function applyImportedRecording(payload) {
            stopPlayback();
            clearRecording();
            clearPointers();
            currentMode = payload.mode || 'single';
            relationMode = payload.relation || 'none';
            if (relationModeSelect) relationModeSelect.value = relationMode;
            currentArrays = payload.arrays || { 1: [] };
            maxArrayId = Math.max(...Object.keys(currentArrays).map(id => Number(id)));
            // ç¡®ä¿è¾“å…¥æ¡†/å®¹å™¨å­˜åœ¨
            Object.keys(currentArrays).forEach(id => {
                const numId = Number(id);
                if (!document.querySelector(`.array-input-wrapper[data-array-id="${numId}"]`)) {
                    createArrayInput(numId);
                }
                if (!document.querySelector(`.array-container[data-array-id="${numId}"]`)) {
                    createArrayContainer(numId);
                }
            });
            if (currentMode === 'single') showOnlyArray(1);
            else if (currentMode === 'double') showArrays([1, 2]);
            else showAllArrays();
            renderArray();
            targetValue = payload.target ?? null;
            if (targetInput) targetInput.value = targetValue ?? '';
            updateTargetFromInput();
            // é‡å»ºæŒ‡é’ˆ
            if (Array.isArray(payload.pointers)) {
                payload.pointers.forEach(p => {
                    addPointerWith(p.name, p.arrayId, p.index, p.pos || 'bottom');
                    const ptr = pointers.find(pp => pp.name === p.name);
                    if (ptr && p.color) {
                        ptr.color = p.color;
                        ptr.element.style.background = p.color;
                        ptr.element.style.setProperty('--pointer-color', p.color);
                    }
                });
            }
            recordLog = Array.isArray(payload.log) ? payload.log : [];
            updateRecordStatus();
            updateTargetHighlight();
            updateRelationHighlight();
        }

        // å¸®åŠ©å‡½æ•°ï¼šæŒ‰åç§°åˆ›å»ºæŒ‡é’ˆå¹¶è®¾ç½®ä½ç½®
        function addPointerWith(name, arrayId, index, positionType) {
            pointerNameInput.value = name;
            addPointer();
            const p = pointers.find(pp => pp.name === name);
            if (p) {
                p.arrayId = arrayId;
                p.index = index;
                p.positionType = positionType || 'bottom';
                p.element.classList.remove('position-top', 'position-bottom');
                p.element.classList.add(`position-${p.positionType}`);
                setPointerPosition(p);
                selectPointer(p);
            }
        }

        // æ¨¡æ¿ï¼šåˆå¹¶æœ‰åºæ•°ç»„
        function applyTemplateMergeSorted() {
            clearPointers();
            // è®¾ç½®åŒæ•°ç»„ä¸ç¤ºä¾‹æ•°æ®
            switchMode('double');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            const input2 = document.querySelector('.array-input[data-array-id="2"]');
            if (input1) input1.value = '1,3,5,7,9';
            if (input2) input2.value = '2,4,6,8,10';
            renderArray();
            // æ·»åŠ æŒ‡é’ˆ
            addPointerWith('i', 1, 0, 'top');
            addPointerWith('j', 2, 0, 'top');
            // æ¸…ç©ºç›®æ ‡ä¸å…³ç³»
            targetInput.value = '';
            updateTargetFromInput();
            showCode('dart', templateDart.mergeSorted);
        }

        // æ¨¡æ¿ï¼šç§»é™¤å…ƒç´ 
        function applyTemplateRemoveElement() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '0,1,2,2,3,0,4,2';
            renderArray();
            // è®¾ç½®ç›®æ ‡ä¸ºå¾…ç§»é™¤å…ƒç´  2
            targetInput.value = '2';
            updateTargetFromInput();
            // ä¸¤æŒ‡é’ˆ
            addPointerWith('i', 1, 0, 'top');
            addPointerWith('j', 1, 0, 'bottom');
            showCode('dart', templateDart.removeElement);
        }

        // æ¨¡æ¿ï¼šäºŒåˆ†æŸ¥æ‰¾
        function applyTemplateBinarySearch() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '1,3,5,7,9,11,13';
            renderArray();
            // è®¾ç½®ç›®æ ‡ 7
            targetInput.value = '7';
            updateTargetFromInput();
            const len = currentArrays[1]?.length || 0;
            addPointerWith('l', 1, 0, 'top');
            addPointerWith('r', 1, Math.max(0, len - 1), 'top');
            addPointerWith('m', 1, Math.floor((len - 1) / 2), 'bottom');
            showCode('dart', templateDart.binarySearch);
        }
        function applyTemplateTwoSum() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '1,2,3,4,6,8,11';
            renderArray();
            targetInput.value = '10';
            updateTargetFromInput();
            const len = currentArrays[1]?.length || 0;
            addPointerWith('l', 1, 0, 'top');
            addPointerWith('r', 1, Math.max(0, len - 1), 'top');
            relationModeSelect.value = 'two-sum';
            relationMode = 'two-sum';
            updateRelationHighlight();
            updateTargetStats();
            showCode('dart', templateDart.twoSum);
        }
        function applyTemplateThreeSum() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '-1,0,1,2,-1,-4';
            renderArray();
            targetInput.value = '0';
            updateTargetFromInput();
            addPointerWith('i', 1, 0, 'top');
            addPointerWith('j', 1, 1, 'bottom');
            addPointerWith('k', 1, 5, 'top');
            relationModeSelect.value = 'three-sum';
            relationMode = 'three-sum';
            updateRelationHighlight();
            updateTargetStats();
            showCode('dart', templateDart.threeSum);
        }
        function applyTemplateSlidingWindow() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '1,4,2,10,23,3,1,0,20';
            renderArray();
            targetInput.value = '15';
            updateTargetFromInput();
            addPointerWith('l', 1, 0, 'top');
            addPointerWith('r', 1, 0, 'bottom');
            showCode('dart', templateDart.slidingWindow);
        }
        function applyTemplateMoveZeros() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '0,1,0,3,12';
            renderArray();
            targetInput.value = '0';
            updateTargetFromInput();
            addPointerWith('i', 1, 0, 'top');
            addPointerWith('j', 1, 0, 'bottom');
            showCode('dart', templateDart.moveZeros);
        }
        function applyTemplateRemoveDuplicates() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '1,1,2,2,3,3,3,4';
            renderArray();
            targetInput.value = '';
            updateTargetFromInput();
            addPointerWith('i', 1, 0, 'top');
            addPointerWith('j', 1, 1, 'bottom');
            showCode('dart', templateDart.removeDuplicates);
        }
        function applyTemplateReverseArray() {
            clearPointers();
            switchMode('single');
            const input1 = document.querySelector('.array-input[data-array-id="1"]');
            if (input1) input1.value = '1,2,3,4,5';
            renderArray();
            targetInput.value = '';
            updateTargetFromInput();
            const len = currentArrays[1]?.length || 0;
            addPointerWith('l', 1, 0, 'top');
            addPointerWith('r', 1, Math.max(0, len - 1), 'bottom');
            showCode('dart', templateDart.reverseArray);
        }
        function startRecording() {
            recordLog = [];
            isRecording = true;
            recordStatus.textContent = `å½•åˆ¶ï¼šè¿›è¡Œä¸­ | æ­¥æ•°ï¼š${recordLog.length}`;
        }
        function stopRecording() {
            isRecording = false;
            recordStatus.textContent = `å½•åˆ¶ï¼šæœªå¼€å§‹ | æ­¥æ•°ï¼š${recordLog.length}`;
        }
        function clearRecording() {
            recordLog = [];
            recordStatus.textContent = `å½•åˆ¶ï¼šæœªå¼€å§‹ | æ­¥æ•°ï¼š0`;
        }
        function updateRecordStatus() {
            recordStatus.textContent = `å½•åˆ¶ï¼š${isRecording ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹'} | æ­¥æ•°ï¼š${recordLog.length}`;
        }
        function playRecording() {
            if (!recordLog.length) return;
            stopPlayback();
            playbackIndex = 0;
            const tick = () => {
                if (playbackIndex >= recordLog.length) {
                    stopPlayback();
                    return;
                }
                const e = recordLog[playbackIndex];
                applyLogEntry(e);
                playbackIndex++;
                playbackTimer = setTimeout(tick, PLAYBACK_BASE_DELAY / playbackSpeed);
            };
            tick();
        }

        function exportRecording() {
            const payload = {
                version: 1,
                timestamp: Date.now(),
                mode: currentMode,
                arrays: currentArrays,
                pointers: pointers.map(p => ({ name: p.name, arrayId: p.arrayId, index: p.index, pos: p.positionType, color: p.color })),
                target: targetValue,
                relation: relationMode,
                log: recordLog
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `arraytool-record-${new Date().toISOString().replace(/[:.]/g,'-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
        
