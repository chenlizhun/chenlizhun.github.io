<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ··åˆç®—æ³•æ¨æ¼”å·¥å…· (Mixed Tool)</title>
    <!-- Prism.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Consolas', 'Microsoft YaHei', monospace;
        }

        body {
            padding: 0.75rem;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        h1 {
            color: #0f3460;
            margin-bottom: 0.8rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 5px;
            border-right: 1px solid #ddd;
            padding-right: 10px;
            margin-right: 5px;
        }
        
        .toolbar-group:last-child {
            border-right: none;
        }

        .btn {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-primary { background: #0f3460; color: white; }
        .btn-primary:hover { background: #1a508b; }

        .btn-success { background: #16c79a; color: white; }
        .btn-success:hover { background: #12a178; }

        .btn-danger { background: #e63946; color: white; }
        .btn-danger:hover { background: #c72c41; }

        .btn-warning { background: #ff9f43; color: white; }
        .btn-warning:hover { background: #ff8e21; }
        
        .btn-purple { background: #8e44ad; color: white; }
        .btn-purple:hover { background: #9b59b6; }

        .btn-outline { background: white; border: 1px solid #ccc; color: #333; }
        .btn-outline:hover { background: #f0f0f0; border-color: #bbb; }
        
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .input-control {
            padding: 0.4rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 80px;
        }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }

        /* å¯è§†åŒ–å·¥ä½œåŒº */
        .workspace {
            background: rgba(240, 242, 245, 0.8);
            border-radius: 12px;
            border: 2px dashed #ccc;
            padding: 20px;
            overflow: auto;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-content: flex-start;
        }

        .workspace.drag-over {
            background: rgba(22, 199, 154, 0.1);
            border-color: #16c79a;
        }

        /* æ•°æ®ç»“æ„å®¹å™¨é€šç”¨æ ·å¼ */
        .ds-container {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
            position: relative;
        }

        .ds-container.active {
            border: 2px solid #0f3460;
            box-shadow: 0 0 0 4px rgba(15, 52, 96, 0.1);
        }

        .ds-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .ds-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: #0f3460;
        }

        .ds-type {
            font-size: 0.7rem;
            color: #666;
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
        }

        .ds-body {
            flex: 1;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }
        
        .ds-close {
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 0.8;
        }
        .ds-close:hover { color: #e63946; }

        /* å…·ä½“æ•°æ®ç»“æ„æ ·å¼ */
        
        /* Stack: ç«–å‘ï¼Œåº•éƒ¨å¯¹é½ */
        .stack-body {
            flex-direction: column-reverse;
            border-bottom: 3px solid #0f3460;
            border-left: 3px solid #0f3460;
            border-right: 3px solid #0f3460;
            border-radius: 0 0 8px 8px;
            padding: 5px;
            width: 100px;
            margin: 0 auto;
        }

        /* Queue: æ¨ªå‘ï¼Œå·¦è¿›å³å‡º (æˆ–å³è¿›å·¦å‡ºï¼Œä¿æŒä¸€è‡´) */
        .queue-body {
            flex-direction: row;
            border-top: 3px solid #0f3460;
            border-bottom: 3px solid #0f3460;
            padding: 5px 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-width: 300px;
            position: relative;
        }
        .queue-body::before { content: 'OUT'; position: absolute; left: 2px; font-size: 0.6rem; font-weight: bold; color: #0f3460; }
        .queue-body::after { content: 'IN'; position: absolute; right: 2px; font-size: 0.6rem; font-weight: bold; color: #0f3460; }

        /* Array: æ¨ªå‘æ ¼å­ */
        .array-body {
            flex-direction: row;
            flex-wrap: wrap;
            gap: 2px;
            max-width: 300px;
        }

        /* HashMap: é”®å€¼å¯¹åˆ—è¡¨ */
        .map-body {
            flex-direction: column;
            width: 100%;
            gap: 4px;
        }

        /* å…ƒç´ é¡¹é€šç”¨æ ·å¼ */
        .item {
            background: white;
            border: 2px solid #0f3460;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #0f3460;
            cursor: grab;
            user-select: none;
            transition: all 0.3s;
            position: relative;
        }
        
        .item:active { cursor: grabbing; }

        /* Stack Item */
        .stack-item { width: 80px; height: 40px; margin-bottom: 2px; }
        
        /* Queue Item */
        .queue-item { width: 50px; height: 50px; margin-right: 5px; flex-shrink: 0; }
        
        /* Array Item */
        .array-item-wrapper { display: flex; flex-direction: column; align-items: center; margin: 2px; }
        .array-index { font-size: 0.6rem; color: #888; margin-bottom: 2px; }
        .array-item { width: 45px; height: 45px; }

        /* Map Item */
        .map-item { 
            width: 100%; 
            height: 40px; 
            display: flex; 
            border: 1px solid #ccc;
            padding: 0 10px;
            justify-content: space-between;
        }
        .map-key { font-size: 0.8rem; color: #e63946; font-weight: bold; border-right: 1px solid #eee; padding-right: 8px; margin-right: 8px; display: flex; align-items: center;}
        .map-val { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* æ‹–æ‹½ç›¸å…³ */
        .dragging { opacity: 0.5; }

        /* å³ä¾§é¢æ¿ */
        .side-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .code-panel {
            flex: 1;
            background: #2d2d2d;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 200px;
        }

        .code-header {
            background: #1e1e1e;
            padding: 8px 12px;
            color: #ddd;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
        }

        .code-editor-container {
            position: relative;
            flex: 1;
            overflow: auto;
        }

        #code-editor, pre {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            margin: 0; padding: 10px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            border: none;
            outline: none;
        }
        #code-editor {
            background: transparent;
            color: transparent;
            z-index: 2;
            resize: none;
            caret-color: white;
        }
        pre { z-index: 1; pointer-events: none; }

        .log-panel {
            height: 150px;
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 8px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.8rem;
        }
        .log-entry { margin-bottom: 2px; border-bottom: 1px solid #333; }

        /* åŠ¨æ€æ“ä½œåŒº */
        #dynamic-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .empty-hint {
            width: 100%;
            text-align: center;
            color: #999;
            margin-top: 50px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ··åˆæ•°æ®ç»“æ„æ¨æ¼” (Mixed Data Structures)</h1>

        <div class="toolbar">
            <div class="toolbar-group">
                <button class="btn btn-primary" onclick="addStructure('stack')">â• Stack</button>
                <button class="btn btn-success" onclick="addStructure('queue')">â• Queue</button>
                <button class="btn btn-warning" onclick="addStructure('array')">â• Array</button>
                <button class="btn btn-purple" onclick="addStructure('map')">â• HashMap</button>
            </div>
            <div class="toolbar-group">
                <select id="algo-select" class="input-control" onchange="loadTemplate()" style="min-width: 150px;">
                    <option value="custom">è‡ªå®šä¹‰ (Custom)</option>
                    <option value="stack_queue">æ ˆä¸é˜Ÿåˆ—äº’æ“ä½œ</option>
                    <option value="bfs">BFS (Queue + Map)</option>
                    <option value="monotonic">å•è°ƒæ ˆ (Array + Stack)</option>
                    <option value="lru">LRU Cache (Map + List)</option>
                </select>
            </div>
            <div class="toolbar-group">
                 <button class="btn btn-danger" onclick="clearWorkspace()">ğŸ—‘ï¸ æ¸…ç©ºå·¥ä½œåŒº</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šå¯è§†åŒ–å·¥ä½œåŒº -->
            <div class="workspace" id="workspace" ondragover="handleDragOver(event)" ondrop="handleDropToWorkspace(event)">
                <div class="empty-hint" id="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ•°æ®ç»“æ„ï¼Œæˆ–é€‰æ‹©æ¨¡æ¿</div>
            </div>

            <!-- å³ä¾§ï¼šæ§åˆ¶ä¸ä»£ç  -->
            <div class="side-panel">
                <!-- åŠ¨æ€æ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <div style="font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between;">
                        <span id="active-structure-name">æœªé€‰æ‹©ç»“æ„</span>
                        <span id="active-structure-type" style="font-size:0.8em; color:#666;"></span>
                    </div>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <input type="text" id="op-input-1" class="input-control" placeholder="Value / Key">
                        <input type="text" id="op-input-2" class="input-control" placeholder="Value (Map/Array)" style="display:none;">
                    </div>
                    <div class="input-group" style="margin-bottom: 10px; display:flex; gap:6px; align-items:center;">
                        <select id="data-template" class="input-control" onchange="applyDataTemplate()" style="min-width:180px;">
                            <option value="none">æ•°æ®æ¨¡æ¿</option>
                            <option value="1234">[1,2,3,4]</option>
                            <option value="abcd">[A,B,C,D]</option>
                            <option value="rand10">éšæœº10ä¸ªæ•°(1..9)</option>
                            <option value="shuffle10">ä¹±åºæ•°ç»„(10)</option>
                            <option value="geo2">å‡ ä½•åºåˆ—(2^n, n=0..9)</option>
                            <option value="letters">å­—æ¯åºåˆ—(A..J)</option>
                            <option value="map-basic">Map: a->1, b->2, c->3</option>
                        </select>
                        <button class="btn btn-outline" onclick="renameActiveStructure()">é‡å‘½åç»“æ„</button>
                    </div>
                    <div id="dynamic-controls">
                        <span style="color:#666; font-size: 0.9em;">è¯·ç‚¹å‡»å·¦ä¾§æŸä¸ªæ•°æ®ç»“æ„ä»¥æ¿€æ´»æ“ä½œé¢æ¿ã€‚</span>
                    </div>
                </div>

                <!-- ä»£ç ç¼–è¾‘å™¨ -->
                <div class="code-panel">
                    <div class="code-header">
                        <span>Dart ä»£ç </span>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <button class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem;" onclick="changeCodeFont(1)">A+</button>
                            <button class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem;" onclick="changeCodeFont(-1)">A-</button>
                            <button class="btn btn-outline" style="padding: 2px 6px; font-size: 0.7rem;" onclick="resetCode()">Reset</button>
                        </div>
                    </div>
                    <div class="code-editor-container">
                        <textarea id="code-editor" spellcheck="false" oninput="syncCode()"></textarea>
                        <pre id="code-highlight" class="line-numbers"><code class="language-dart" id="code-content"></code></pre>
                    </div>
                </div>

                <!-- æ—¥å¿— -->
                <div class="log-panel" id="log-panel">
                    <div class="log-entry">> ç³»ç»Ÿå°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

    <script>
        // === å…¨å±€çŠ¶æ€ ===
        let structures = {}; // id -> object
        let nextId = 1;
        let activeId = null;
        let draggedData = null; // { sourceId, val, type }

        // === æ•°æ®ç»“æ„ç±»å®šä¹‰ ===
        class BaseStructure {
            constructor(type, title) {
                this.id = `ds-${nextId++}`;
                this.type = type;
                this.title = title || `${type.charAt(0).toUpperCase() + type.slice(1)} ${this.id.split('-')[1]}`;
                this.container = null;
                this.bodyElement = null;
            }

            render() {
                const div = document.createElement('div');
                div.className = 'ds-container';
                div.id = this.id;
                div.onclick = (e) => {
                    e.stopPropagation();
                    activateStructure(this.id);
                };
                div.ondragover = (e) => {
                    e.preventDefault();
                    div.classList.add('drag-over');
                };
                div.ondragleave = () => div.classList.remove('drag-over');
                div.ondrop = (e) => this.handleDrop(e);

                div.innerHTML = `
                    <div class="ds-header">
                        <div>
                            <span class="ds-title">${this.title}</span>
                            <span class="ds-type">${this.type.toUpperCase()}</span>
                        </div>
                        <span class="ds-close" onclick="removeStructure('${this.id}', event)">Ã—</span>
                    </div>
                    <div class="ds-body ${this.type}-body" id="${this.id}-body"></div>
                `;
                
                this.container = div;
                this.bodyElement = div.querySelector('.ds-body');
                const titleEl = div.querySelector('.ds-title');
                titleEl.ondblclick = () => {
                    const nv = prompt('é‡å‘½åç»“æ„', this.title);
                    if (nv && nv.trim()) { this.title = nv.trim(); titleEl.innerText = this.title; updateControlPanel(); }
                };
                return div;
            }

            handleDrop(e) {
                e.preventDefault();
                e.stopPropagation();
                this.container.classList.remove('drag-over');
                
                if (draggedData) {
                    // å¦‚æœä»åŒä¸€ä¸ªç»“æ„æ‹–åŠ¨ï¼Œåˆ™ä¸å¤„ç†ï¼ˆæˆ–æ˜¯é‡æ–°æ’åºï¼Œè¿™é‡Œæš‚ç•¥ï¼‰
                    // if (draggedData.sourceId === this.id) return;

                    // é€»è¾‘ï¼šå¦‚æœä»å…¶ä»–ç»“æ„æ‹–å…¥ï¼Œè§†ä¸ºâ€œç§»åŠ¨â€æˆ–â€œå¤åˆ¶â€
                    // ç®€å•èµ·è§ï¼Œè¿™é‡Œå®ç°â€œæ·»åŠ â€é€»è¾‘
                    // åªæœ‰ Map éœ€è¦ Keyï¼Œå¦‚æœæ‹–å…¥ Mapï¼Œå¯èƒ½éœ€è¦å¼¹çª—æˆ–é»˜è®¤ Key
                    
                    if (this.type === 'map') {
                        const key = prompt(`è¯·è¾“å…¥å€¼ ${draggedData.val} çš„ Key:`);
                        if (key) this.add(key, draggedData.val);
                    } else if (this.type === 'array') {
                        this.add(draggedData.val); // Append
                    } else {
                        this.add(draggedData.val);
                    }
                    
                    log(`Dropped ${draggedData.val} into ${this.title}`);
                    draggedData = null;
                }
            }

            // å­ç±»å®ç°
            add(val) {} 
            getControls() { return []; }
        }

        class Stack extends BaseStructure {
            constructor() { super('stack'); this.items = []; }

            add(val) { this.push(val); }

            push(val) {
                if (!val) return;
                this.items.push(val);
                this.updateView();
            }

            pop() {
                if (this.items.length === 0) return null;
                const val = this.items.pop();
                this.updateView();
                return val;
            }

            peek() { return this.items[this.items.length - 1]; }

            setAt(index, val) {
                if (index >= 0 && index < this.items.length) {
                    this.items[index] = val;
                    this.updateView();
                }
            }

            updateView() {
                this.bodyElement.innerHTML = '';
                this.items.forEach((val, idx) => {
                    const item = createItem(val, 'stack-item', this.id, idx);
                    this.bodyElement.appendChild(item);
                });
            }

            getControls() {
                return [
                    { label: 'Push', action: 'push', color: 'btn-primary' },
                    { label: 'Pop', action: 'pop', color: 'btn-danger' },
                    { label: 'Peek', action: 'peek', color: 'btn-success' }
                ];
            }
        }

        class Queue extends BaseStructure {
            constructor() { super('queue'); this.items = []; }

            add(val) { this.enqueue(val); }

            enqueue(val) {
                if (!val) return;
                this.items.push(val);
                this.updateView();
            }

            dequeue() {
                if (this.items.length === 0) return null;
                const val = this.items.shift();
                this.updateView();
                return val;
            }
            
            front() { return this.items[0]; }

            setAt(index, val) {
                if (index >= 0 && index < this.items.length) {
                    this.items[index] = val;
                    this.updateView();
                }
            }

            updateView() {
                this.bodyElement.innerHTML = '';
                this.items.forEach((val, idx) => {
                    const item = createItem(val, 'queue-item', this.id, idx);
                    this.bodyElement.appendChild(item);
                });
            }

            getControls() {
                return [
                    { label: 'Enqueue', action: 'enqueue', color: 'btn-primary' },
                    { label: 'Dequeue', action: 'dequeue', color: 'btn-danger' },
                    { label: 'Front', action: 'front', color: 'btn-success' }
                ];
            }
        }

        class VisualArray extends BaseStructure {
            constructor() { super('array'); this.items = []; }

            add(val) { this.items.push(val); this.updateView(); }

            set(index, val) {
                if (index >= 0 && index < this.items.length) {
                    this.items[index] = val;
                    this.updateView();
                } else if (index == this.items.length) {
                    this.add(val);
                } else {
                    log(`Index ${index} out of bounds`);
                }
            }

            get(index) { return this.items[index]; }

            removeAt(index) {
                if (index >= 0 && index < this.items.length) {
                    const val = this.items.splice(index, 1)[0];
                    this.updateView();
                    return val;
                }
                return null;
            }

            moveItem(fromIndex, toIndex) {
                if (fromIndex === toIndex) return;
                if (fromIndex < 0 || toIndex < 0 || fromIndex >= this.items.length || toIndex >= this.items.length) return;
                const [v] = this.items.splice(fromIndex, 1);
                this.items.splice(toIndex, 0, v);
                this.updateView();
                log(`Array move: ${fromIndex} -> ${toIndex}`);
            }

            swap(i, j) {
                if (i === j) return;
                if (i < 0 || j < 0 || i >= this.items.length || j >= this.items.length) return;
                const tmp = this.items[i];
                this.items[i] = this.items[j];
                this.items[j] = tmp;
                this.updateView();
                log(`Array swap: ${i} <-> ${j}`);
            }

            updateView() {
                this.bodyElement.innerHTML = '';
                this.items.forEach((val, idx) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'array-item-wrapper';
                    
                    const idxSpan = document.createElement('span');
                    idxSpan.className = 'array-index';
                    idxSpan.innerText = idx;
                    
                    const item = createItem(val, 'array-item', this.id, idx);
                    
                    wrapper.appendChild(idxSpan);
                    wrapper.appendChild(item);
                    this.bodyElement.appendChild(wrapper);
                });
            }

            getControls() {
                // Array controls need 2 inputs usually (index, value)
                return [
                    { label: 'Append', action: 'append', color: 'btn-primary' },
                    { label: 'Set(Idx, Val)', action: 'set', color: 'btn-warning', needsInput2: true },
                    { label: 'Get(Idx)', action: 'get', color: 'btn-success' },
                    { label: 'Remove(Idx)', action: 'remove', color: 'btn-danger' },
                    { label: 'Swap(i, j)', action: 'swap', color: 'btn-outline', needsInput2: true }
                ];
            }
        }

        class HashMap extends BaseStructure {
            constructor() { super('map'); this.map = new Map(); }

            add(key, val) { this.put(key, val); } // Generic add interface

            put(key, val) {
                if (!key) return;
                this.map.set(key, val);
                this.updateView();
            }

            get(key) { return this.map.get(key); }

            remove(key) {
                this.map.delete(key);
                this.updateView();
            }

            updateView() {
                this.bodyElement.innerHTML = '';
                this.map.forEach((val, key) => {
                    const div = document.createElement('div');
                    div.className = 'map-item item';
                    div.draggable = true;
                    div.ondragstart = (e) => {
                        draggedData = { sourceId: this.id, val: val, key: key, type: 'map' };
                        e.dataTransfer.effectAllowed = 'copy';
                        div.classList.add('dragging');
                    };
                    div.ondragend = () => div.classList.remove('dragging');
                    
                    div.innerHTML = `
                        <span class="map-key">${key}</span>
                        <span class="map-val">${val}</span>
                    `;
                    const keyEl = div.querySelector('.map-key');
                    const valEl = div.querySelector('.map-val');
                    keyEl.ondblclick = () => {
                        const nk = prompt('ç¼–è¾‘ Key', key);
                        if (nk && nk.trim()) { this.map.delete(key); this.map.set(nk.trim(), val); this.updateView(); log(`Key ä¿®æ”¹ä¸º ${nk.trim()}`); }
                    };
                    valEl.ondblclick = () => {
                        const nv = prompt('ç¼–è¾‘ Value', val);
                        if (nv !== null) { this.map.set(key, nv); this.updateView(); log(`Value ä¿®æ”¹ä¸º ${nv}`); }
                    };
                    this.bodyElement.appendChild(div);
                });
            }

            getControls() {
                return [
                    { label: 'Put(Key, Val)', action: 'put', color: 'btn-purple', needsInput2: true },
                    { label: 'Get(Key)', action: 'get', color: 'btn-success' },
                    { label: 'Remove(Key)', action: 'remove', color: 'btn-danger' }
                ];
            }
        }

        // === è¾…åŠ©å‡½æ•° ===
        function createItem(val, className, sourceId, index) {
            const div = document.createElement('div');
            div.className = `item ${className}`;
            div.innerText = val;
            div.draggable = true;
            div.ondragstart = (e) => {
                draggedData = { sourceId: sourceId, val: val, index: index, type: 'simple' };
                e.dataTransfer.effectAllowed = 'copy';
                div.classList.add('dragging');
            };
            div.ondragend = () => div.classList.remove('dragging');
            div.ondragover = (e) => { e.preventDefault(); };
            div.ondrop = (e) => {
                e.preventDefault();
                const s = structures[sourceId];
                if (!s) return;
                if (s.type === 'array' && draggedData && draggedData.sourceId === sourceId && typeof draggedData.index === 'number') {
                    s.moveItem(draggedData.index, index);
                    draggedData = null;
                }
            };
            div.ondblclick = () => {
                const s = structures[sourceId];
                if (!s) return;
                const nv = prompt('ç¼–è¾‘å€¼', String(val));
                if (nv === null) return;
                if (s.type === 'array') {
                    if (typeof index === 'number') s.set(index, nv);
                } else if (s.type === 'stack') {
                    if (typeof index === 'number') s.setAt(index, nv);
                } else if (s.type === 'queue') {
                    if (typeof index === 'number') s.setAt(index, nv);
                }
            };
            return div;
        }

        function log(msg) {
            const panel = document.getElementById('log-panel');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date().toLocaleTimeString();
            entry.innerText = `[${time}] ${msg}`;
            panel.prepend(entry);
        }

        // === æ ¸å¿ƒé€»è¾‘ ===
        
        function addStructure(type, title) {
            document.getElementById('empty-hint').style.display = 'none';
            let s;
            if (type === 'stack') s = new Stack();
            else if (type === 'queue') s = new Queue();
            else if (type === 'array') s = new VisualArray();
            else if (type === 'map') s = new HashMap();
            
            if (title) s.title = title;
            
            structures[s.id] = s;
            document.getElementById('workspace').appendChild(s.render());
            activateStructure(s.id);
            log(`Created ${s.title}`);
            return s;
        }

        function removeStructure(id, event) {
            if (event) event.stopPropagation();
            if (structures[id]) {
                document.getElementById(id).remove();
                delete structures[id];
                if (activeId === id) {
                    activeId = null;
                    updateControlPanel();
                }
                log(`Removed structure ${id}`);
                
                if (Object.keys(structures).length === 0) {
                    document.getElementById('empty-hint').style.display = 'block';
                }
            }
        }

        function clearWorkspace() {
            document.getElementById('workspace').innerHTML = '<div class="empty-hint" id="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ•°æ®ç»“æ„ï¼Œæˆ–é€‰æ‹©æ¨¡æ¿</div>';
            structures = {};
            activeId = null;
            updateControlPanel();
            log('Workspace cleared');
        }

        function activateStructure(id) {
            // Remove active class from old
            if (activeId && document.getElementById(activeId)) {
                document.getElementById(activeId).classList.remove('active');
            }
            
            activeId = id;
            if (document.getElementById(id)) {
                document.getElementById(id).classList.add('active');
                updateControlPanel();
            }
        }

        function updateControlPanel() {
            const nameEl = document.getElementById('active-structure-name');
            const typeEl = document.getElementById('active-structure-type');
            const controlsDiv = document.getElementById('dynamic-controls');
            const input1 = document.getElementById('op-input-1');
            const input2 = document.getElementById('op-input-2');
            
            controlsDiv.innerHTML = '';
            
            if (!activeId || !structures[activeId]) {
                nameEl.innerText = 'æœªé€‰æ‹©ç»“æ„';
                typeEl.innerText = '';
                controlsDiv.innerHTML = '<span style="color:#666; font-size: 0.9em;">è¯·ç‚¹å‡»å·¦ä¾§æŸä¸ªæ•°æ®ç»“æ„ä»¥æ¿€æ´»æ“ä½œé¢æ¿ã€‚</span>';
                input1.disabled = true;
                input2.style.display = 'none';
                return;
            }

            const s = structures[activeId];
            nameEl.innerText = s.title;
            typeEl.innerText = s.type.toUpperCase();
            input1.disabled = false;
            
            // Adjust inputs based on type
            if (s.type === 'map') {
                input1.placeholder = 'Key';
                input2.style.display = 'block';
                input2.placeholder = 'Value';
            } else if (s.type === 'array') {
                input1.placeholder = 'Index / Value';
                input2.style.display = 'block';
                input2.placeholder = 'Value (for Set)';
            } else {
                input1.placeholder = 'Value';
                input2.style.display = 'none';
            }

            // Generate buttons
            const actions = s.getControls();
            actions.forEach(act => {
                const btn = document.createElement('button');
                btn.className = `btn ${act.color}`;
                btn.innerText = act.label;
                btn.onclick = () => performAction(s, act.action);
                controlsDiv.appendChild(btn);
            });
        }

        function performAction(structure, action) {
            const val1 = document.getElementById('op-input-1').value.trim();
            const val2 = document.getElementById('op-input-2').value.trim();
            
            let result;
            
            switch (action) {
                case 'push': structure.push(val1); break;
                case 'pop': result = structure.pop(); if (result) log(`Popped: ${result}`); break;
                case 'peek': result = structure.peek(); if (result) log(`Peek: ${result}`); break;
                
                case 'enqueue': structure.enqueue(val1); break;
                case 'dequeue': result = structure.dequeue(); if (result) log(`Dequeued: ${result}`); break;
                case 'front': result = structure.front(); if (result) log(`Front: ${result}`); break;
                
                case 'append': structure.add(val1); break;
                case 'set': structure.set(parseInt(val1), val2); break;
                case 'get': 
                    if (structure.type === 'map') result = structure.get(val1);
                    else result = structure.get(parseInt(val1));
                    log(`Get result: ${result}`); 
                    break;
                case 'remove': 
                    if (structure.type === 'map') structure.remove(val1);
                    else structure.removeAt(parseInt(val1));
                    break;
                case 'swap': 
                    if (structure.type === 'array') structure.swap(parseInt(val1), parseInt(val2));
                    break;
                
                case 'put': structure.put(val1, val2); break;
            }
        }

        function handleDragOver(e) { e.preventDefault(); }
        function handleDropToWorkspace(e) { e.preventDefault(); } // å…è®¸æ‹–æ‹½åˆ°ç©ºç™½å¤„ä½†ä¸åšæ“ä½œï¼Œæˆ–è€…å¯ä»¥æ–°å»ºï¼Ÿ

        // === æ¨¡æ¿ä¸ä»£ç  ===
        const templates = {
            custom: '',
            stack_queue: `// æ ˆä¸é˜Ÿåˆ—äº’æ“ä½œæ¼”ç¤º
// 1. åˆ›å»ºä¸€ä¸ª Stack å’Œä¸€ä¸ª Queue
// 2. å°†æ•°æ® Push è¿› Stack
// 3. å°† Stack æ•°æ® Pop å¹¶ Enqueue åˆ° Queue
// 4. è§‚å¯Ÿæ•°æ®é¡ºåºå˜åŒ– (FILO -> FIFO)
`,
            bfs: `// BFS å¹¿åº¦ä¼˜å…ˆæœç´¢æ¨¡æ‹Ÿ
// éœ€è¦: Queue (frontier), Map (visited), Map (parent)
// 1. Enqueue èµ·å§‹èŠ‚ç‚¹
// 2. å¾ªç¯ç›´åˆ° Queue ä¸ºç©º
// 3. Dequeue å½“å‰èŠ‚ç‚¹
// 4. å°†é‚»å±… Enqueue å¹¶è®°å½• Visited
`,
            monotonic: `// å•è°ƒæ ˆæ¼”ç¤º
// éœ€è¦: Array (è¾“å…¥), Stack (å•è°ƒæ ˆ)
// éå† Array:
//   While Stack ä¸ä¸ºç©º ä¸” StackTop < Current:
//     Pop Stack (æ‰¾åˆ°å³ä¾§ç¬¬ä¸€ä¸ªæ¯”å®ƒå¤§çš„æ•°)
//   Push Current
`,
            lru: `// LRU Cache æ¨¡æ‹Ÿ
// éœ€è¦: HashMap (Key -> Node), DoubleLinkedList (æ¨¡æ‹Ÿç”¨ Queue è¿‘ä¼¼æˆ– Array)
// Get(key):
//   å¦‚æœå­˜åœ¨ï¼Œç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨ (Remove + Add)
// Put(key, val):
//   å¦‚æœæ»¡ï¼Œç§»é™¤é“¾è¡¨å°¾éƒ¨ (LRU)
//   æ·»åŠ åˆ°å¤´éƒ¨
`
        };

        function loadTemplate() {
            const key = document.getElementById('algo-select').value;
            const editor = document.getElementById('code-editor');
            
            // Setup structures based on template
            if (key !== 'custom') {
                clearWorkspace();
                if (key === 'stack_queue') {
                    addStructure('stack', 'Source Stack');
                    addStructure('queue', 'Dest Queue');
                } else if (key === 'bfs') {
                    addStructure('queue', 'Frontier Queue');
                    addStructure('map', 'Visited Map');
                    addStructure('map', 'Parent Map');
                } else if (key === 'monotonic') {
                    const arr = addStructure('array', 'Input Array');
                    [2, 1, 5, 6, 2, 3].forEach(n => arr.add(n));
                    addStructure('stack', 'Monotonic Stack');
                } else if (key === 'lru') {
                    addStructure('map', 'Cache Map');
                    addStructure('array', 'LRU List (0=Recent)');
                }
            }
            
            editor.value = templates[key] || '';
            syncCode();
        }

        function syncCode() {
            const code = document.getElementById('code-editor').value;
            document.getElementById('code-content').textContent = code;
            Prism.highlightElement(document.getElementById('code-content'));
        }

        function resetCode() {
            loadTemplate();
        }

        let codeFontSize = 14;
        function changeCodeFont(delta) {
            codeFontSize = Math.max(10, Math.min(28, codeFontSize + delta));
            const editor = document.getElementById('code-editor');
            const pre = document.getElementById('code-highlight');
            const code = document.getElementById('code-content');
            if (editor) editor.style.fontSize = codeFontSize + 'px';
            if (pre) pre.style.fontSize = codeFontSize + 'px';
            if (code) code.style.fontSize = codeFontSize + 'px';
        }

        function renameActiveStructure() {
            if (!activeId || !structures[activeId]) return;
            const s = structures[activeId];
            const nv = prompt('é‡å‘½åç»“æ„', s.title);
            if (nv && nv.trim()) {
                s.title = nv.trim();
                const titleEl = document.querySelector(`#${s.id} .ds-title`);
                if (titleEl) titleEl.innerText = s.title;
                updateControlPanel();
            }
        }

        function applyDataTemplate() {
            const sel = document.getElementById('data-template');
            const key = sel ? sel.value : 'none';
            if (key === 'none') return;
            if (!activeId || !structures[activeId]) { sel.value = 'none'; return; }
            const s = structures[activeId];
            const fillArray = (arr) => {
                if (s.type === 'array') { s.items = []; arr.forEach(v => s.add(v)); }
                else if (s.type === 'queue') { s.items = []; arr.forEach(v => s.enqueue(v)); }
                else if (s.type === 'stack') { s.items = []; arr.forEach(v => s.push(v)); }
            };
            if (key === '1234') fillArray([1,2,3,4]);
            else if (key === 'abcd') fillArray(['A','B','C','D']);
            else if (key === 'rand10') fillArray(Array.from({length:10}, () => Math.floor(Math.random()*9)+1));
            else if (key === 'shuffle10') {
                const arr = Array.from({length:10}, (_,i)=>i+1);
                for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; }
                fillArray(arr);
            }
            else if (key === 'geo2') fillArray(Array.from({length:10}, (_,i)=>Math.pow(2,i)));
            else if (key === 'letters') fillArray(['A','B','C','D','E','F','G','H','I','J']);
            else if (key === 'map-basic' && s.type === 'map') {
                s.map = new Map();
                s.put('a','1'); s.put('b','2'); s.put('c','3');
            }
            sel.value = 'none';
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            // é»˜è®¤æ·»åŠ å‡ ä¸ªä»¥ä¾¿å±•ç¤º
            addStructure('stack');
            addStructure('queue');
            syncCode();
        };

    </script>
</body>
</html>
